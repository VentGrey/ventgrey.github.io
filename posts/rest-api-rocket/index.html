<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Crear y consumir una REST API con Rust y Rocket | La Esquina Gris</title><meta name=keywords content="Rust,Rocket,API,Svelte,Base de datos"><meta name=description content="Todas las API son iguales. ¿Qué tan igual será una hecha en Rust y Rocket?"><meta name=author content="VentGrey"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="Iyb36hxWrYaEXR1JJHRsc-E3vXidjcKH8hdE1pU5KxA"><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ventgrey.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ventgrey.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ventgrey.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ventgrey.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ventgrey.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Crear y consumir una REST API con Rust y Rocket"><meta property="og:description" content="Todas las API son iguales. ¿Qué tan igual será una hecha en Rust y Rocket?"><meta property="og:type" content="article"><meta property="og:url" content="https://ventgrey.github.io/posts/rest-api-rocket/"><meta property="og:image" content="https://ventgrey.github.io/img/posts/api/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-24T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-24T00:00:00+00:00"><meta property="og:site_name" content="La Esquina Gris - Escribo un blog por terapia"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ventgrey.github.io/img/posts/api/cover.png"><meta name=twitter:title content="Crear y consumir una REST API con Rust y Rocket"><meta name=twitter:description content="Todas las API son iguales. ¿Qué tan igual será una hecha en Rust y Rocket?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ventgrey.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Crear y consumir una REST API con Rust y Rocket","item":"https://ventgrey.github.io/posts/rest-api-rocket/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Crear y consumir una REST API con Rust y Rocket","name":"Crear y consumir una REST API con Rust y Rocket","description":"Todas las API son iguales. ¿Qué tan igual será una hecha en Rust y Rocket?","keywords":["Rust","Rocket","API","Svelte","Base de datos"],"articleBody":"Y es que…todas las API son iguales. Seamos sinceros, todos hemos hecho al menos una REST API en nuestra vida, honestamente es algo de esperarse, siendo el estilo de arquitectura de software más popular de los últimos años. Si bien REST no es algo nuevo (Pues, su existencia puede rastrearse hasta el año 2000) sigue siendo un enfoque de desarrollo modular y en un todo muy conveniente. Sobre todo si hablamos de tecnologías basadas en la web.\nNo creo que sea necesario dar tanto contexto sobre qué es una REST API, mucho menos en estos años donde podemos encontrar (sin exagerar) miles de sitios donde se nos podría explicar perfectamente que son las REST API, como funcionan, sus casos de uso, ventajas, desventajas y todas esas cosas que nos encanta leer para excusar una flamewar en foros o grupos de chat.\nPara esta entrada vamos a ver como crear y consumir una REST API. Con la parte de la creación utilizaremos Rust con Rocket y para la parte del consumo una página web con un script básico debería funcionar. Asímismo voy a utilizar como ejemplo mi proyecto personal “upventrs” (Por: UpVent RustSvelte). Donde pondré ejemplos de como podemos consumir nuestra REST API desde un framework para JavaScript como Svelte.\nPrerequisitos Este es un trabajo o más bien un proyecto de medio nivel, por lo que se requiere tener un poco de experiencia con el lenguaje de programación Rust y, para la parte del “Frontend” es necesario conocer un poco de Svelte.\nClaro, puedes seguir este tutorial sin cumplir estos prerequisitos, pero te será más complicado entender lo que de por si no puedo explicar a la perfección.\nSi te interesa aprender un poco más aquí te dejo una lista de recursos que podrías encontrar interesantes:\nEjercicios para dominar Rust Compilación de ejemplos de Svelte Svelte en 100 segundos Preparando el entorno de trabajo Si estás leyendo este tutorial asumiré que ya tienes un poco de experiencia con Rust (por lo menos la instalación debería ser algo que ya lograste hacer con éxito). Para este trabajo vamos a crear un binario de Rust y añadiremos algunas dependencias.\nEl magnánimo ORM Los ORM ya son el pan de cada día para los DBA (Database Administrator) y también para los desarrolladores backend. En este proyecto necesitaremos un ORM hecho en Rust que nos permita crear, modificar o re-ejecutar migraciones en nuestra base de datos. Para nuestra fortuna existe Diesel, un ORM que ya está bastante maduro y que, además tiene otras ventajas que para un desarrollador de Rust solo podrían describirse como “jugosas”.\nDiesel previene errores en tiempo de ejecución ya que, por diseño elimina la posiblidad de interactuar de forma incorrecta con la base de datos, si tu proyecto compila con Diesel no deberían existir errores que detengan su ejecución por una mala consulta. Además es terriblemente rápido y su código es MUY reutilizable en codebases grandes, lo cual, como desarrollador te ahorra mucho tiempo. La otra ventaja de Diesel es que no soporta una cantidad masiva de motores de bases de datos, por el momento Diesel solo tiene soporte para:\nMySQL / MariaDB PostgreSQL SQLite3 Digo ventaja, porque la cantidad de motores de manejo de base de datos que hay hoy en día es enorme y las diferencias entre uno y otro son ridículas, algunas son razonables pero…siendo sinceros otras se hacen notar en entornos extraños (o enormes) de producción y en precios ridículos al momento de pagar. Diesel reduce esto diciendo de forma indirecta: “Úsame con lo que está bien hecho o no me uses”.\nLa parte de los motores de base de datos noSQL es otra historia, Diesel no está hecho para bases de datos no relacionales y este tipo de motores normalmente ya vienen con bibliotecas para varios lenguajes incluyendo Rust, MongoDB es el ejemplo más cercano que tengo de esto.\nExiste un problema con todo esto, necesitamos instalar la herramienta CLI (command line interface) de diesel, sin embargo, por la naturaleza del mismo necesitamos elegir las bibliotecas necesarias para poder compilar un binario acorde a nuestro sistema y a la base de datos que utilizaremos en nuestro proyecto.\nPara mantener el concepto sencillo utilizaremos SQLite3 como base de datos para desarrollo. Si deseas utilizar otra cosa como PostgreSQL o MariaDB solo tendrás que sustituir algunas cosas. Parece confuso por ahora, pero una vez entiendas el código y el funcionamiento de Diesel te será sencillo migrar de una base de datos a otra.\nInstalando Diesel con soporte para SQLite3 Diesel necesitará las bibliotecas de SQLite3 para poder compilarse correctamente en nuestra máquina, la biblioteca en cuestión se llama libsqlite3 y existen diversas formas de instalarla en nuestros sistemas. No puedo hacer una lista entera de como instalar dicha biblioteca en todos los sistemas disponibles, en sistemas como Debian y Ubuntu puedes instalar esta biblioteca con la orden: sudo apt install libsqlite3-dev.\nUna vez instalada la biblioteca de SQLite3 solo queda instalar Diesel usando Cargo en nuestra terminal: cargo install diesel_cli --no-default-features --features sqlite\nLos tiempos de compilación de Rust son lentos, sugiero que encuentres algo que hacer mientras el binario de Diesel se compila. Cuando Diesel termine de compilarse podemos continuar con el siguiente paso.\nCrear un proyecto como un buen dev moderno…lleno de dependencias externas. Para crear un nuevo proyecto de Rust necesitamos usar la herramienta Cargo, de nuevo y como dije al inicio de esta entrada de blog, estoy asumiendo que ya tienes algo de experiencia con Rust. En caso de que hayas olvidado como crear un nuevo binario te recuerdo que la orden es: cargo new --bin . En mi caso yo llamaré mi proyecto: rest-rust-template y encontrarás el enlace del repositorio al final de esta entrada. Eres libre de utilizar este repositorio como plantilla para futuros proyectos de REST API con Rust.\nDentro de nuestro proyecto de Rust debemos encontrar el archivo Cargo.toml y ahí añadir las dependencias necesarias. Antes de hacer esto debo hacer una recomendación y es que, cada que necesites utilizar una biblioteca hecha en Rust es recomendable que leas la documentación oficial en https://docs.rs/. La razón por la que digo esto es por que he visto una gran cantidad de tutoriales donde importan bibliotecas externas sin saber que a veces, la misma biblioteca que están utilizando tiene incrustadas las funciones de las bibliotecas externas por lo que solo estamos gastando espacio en disco y namespace.\nEn el caso de Diesel, necesitamos importarlo con dos features especiales, en este caso soporte para SQLite3 y r2d2 (un manejador de “Pools” para bases de datos. No te preocupes, explicaré esto a detalle más abajo).\nEl día en el que estoy escribiendo este blog, la versión de Diesel es la 1.4.4, esto cambiará en el futuro. Asegúrate de seguir las instrucciones en el sitio oficial de Diesel.\nDebemos añadir la siguiente línea a nuestro archivo Cargo.toml para instalar Diesel con las características mencionadas anteriormente:\ndiesel = { version = \"1.4.4\", features = [\"sqlite\", \"r2d2\"] } Una vez hecho esto ejecutamos en nuestra consola (o IDE) el comando $ cargo build para constuir nuestro proyecto con Diesel y continuar trabajando correctamente.\nAhora viene la parte interesante y es colocar nuestra conexión a la base de datos en nuestro proyecto. Es bien sabido que, escribir la conexión en un string directamente en nuestro código es un error terrible, por lo que haremos uso de otra biblioteca llamada dotenv. Dotenv nos permite leer variables de entorno y guardarlas en nuestro programa para usarlas en un futuro, estas pueden leerse desde nuestro sistema o desde un archivo especial de nombre .env. Si has desarrollado un sistema anteriormente con otro lenguaje y framework como Python con Django o Flask ya tendrás algo de experiencia con este tipo de práctica.\nDe nuevo, ahora mismo que estoy escribiendo este blog la versión de dotenv es la 0.15.0 y, otra vez, esto puede cambiar en un futuro no muy lejano. Para añadir dotenv a nuestras dependencias debemos añadir la siguiente línea a nuestro archivo Cargo.toml:\ndotenv = \"0.15.0\" La compilación de dotenv no debería tardar mucho.\nLa paciencia es virtud de sabios, pronto podremos comenzar a programar nuestra REST API, por el momento solo debemos escribir la URL de conexión a la base de datos en un archivo .env que Dotenv leerá desde nuestro código en Rust. Para manejadores de bases de datos más complejos la URL requiere de parámetros más específicos, sin embargo con SQLite3 esto no es necesario, solo debemos indicar el archivo donde guardaremos nuestros datos, todo esto puede lograrse de una forma sencilla con una sola orden en la línea de comandos:\n$ echo DATABASE_URL=debug.db \u003e .env Hecho esto debemos ejecutar $ diesel setup. Si el archivo debug.db no existe no pasa nada, diesel lo creará por nosotros.\nAntes de comenzar a programar debemos crear un archivo más además de nuestro archivo principal de Rust (main.rs), debemos crear un archivo llamado models.rs donde guardaremos los modelos de nuestra base de datos.\nCreado nuestro archivo models.rs tenemos todo listo para comenzar a programar como todos unos campeones.\nCreando los modelos para la base de datos Para este ejemplo haremos una pequeña REST API para una tienda de mascotas, específicamente una tienda que vende gatos. Dentro de la misma guardaremos cuatro datos diferentes:\nNombre del Gato Foto del gato ¿Ya lo adoptaron? Descripción del gato Para activar los lints y el uso correcto de los módulos en rust, debemos añadir la siguiente línea a nuestro archivo main.rs, recomiendo ponerla arriba de la función main, pero debajo de donde importamos las bibliotecas que usaremos en un futuro. Nuestro archivo main.rs deberá verse así:\nuse std::io; mod models; fn main() { println!(\"Hello, world!\"); } Ahora regresemos a nuestro archivo models.rs, aquí debemos importar tres cosas de Diesel para comenzar a trabajar:\nuse diesel; use diesel::prelude::*; use diesel::sqlite::SqliteConnection; El primer import traerá al namespace las partes escenciales de Diesel, el segundo es el prelude, en escencia el prelude es una medida que se implemente para bibliotecas muy grandes que tienen una cantidad muy grande de funciones ampliamente usadas. Importar estas funciones una por una resultaría en un archivo muy grande o simplemente muy verboso\nAhora debemos crear una estructura con visiblidad “Pública” donde guardaremos nuestros datos, en este caso la estructura se llamará Cat (gato, en inglés), entonces, dentro de nuestro archivo models.rs escribiremos la estructura correspondiente:\npub struct Cat { pub id: i32, pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } Los campos de Cat son los siguientes:\nid: El identificador numérico del gato en cuestión name: El nombre del gato photo_url: La dirección web donde podemos encontrar una foto de nuestro gato is_adopted: Un booleano que nos indicará si ya adoptaron al gatito o no description: La descripción del gato Para que Diesel reconozca esto como una tabla para la base de datos, debemos añadir un atributo a la estructura, en este caso el atributo es #[derive(Queryable)]. Al final nuestro archivo models.rs debería verse así:\nuse diesel; use diesel::prelude::*; use diesel::sqlite::SqliteConnection; #[derive(Queryable)] pub struct Cat { pub id: i32, pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } No te preocupes por los warnings de imports sin usar, pronto comenzaremos a implementarlos.\n¿Recuerdas cuando ejecutamos el comando diesel setup? Pues cuando entramos en el directorio de nuestro proyecto podremos ver una nueva carpeta llamada migrations pero, por el momento estará vacío. Para crear una nueva migración necesitaremos ejecutar el comando diesel migration generate create_cats. Puedes cambiar la parte de create_cats por el nombre que desees.\nSi todo salió bien habrá un nuevo directorio con el formato yyy-mm-dd-uuid_nombre, en este caso el directorio de los gatitos se llama 2022-01-25-033422_create_cats, dentro de este directorio se crearán dos archivos, un archivo up.sql y un archivo down.sql.\nEl archivo up.sql servirá para crear las tablas o hacer las operaciones necesarias en la migración. Antes de hacer nada, Diesel revisará este archivo y nos informará de errores de sintaxis o consultas que podrían ser potencialmente dañinas para la integridad de la base de datos.\nPor otra parte el archivo down.sql se encargará de deshacer TODO lo que el archivo up.sql haga en la base de datos.\nPersonalmente esto es lo que me gusta de Diesel como ORM, al menos la parte de creación / eliminación de tablas se le deja completamente al usuario y, si bien uno podría argumentar que “El ORM lo hace mejor”, lo cierto es que, utilizando otro tipo de lenguaje, te falta mucho barrio si te equivocas creando o eliminado tablas, especialamente tablas sin dependencias o llaves foráneas.\nPrimero debemos modificar nuestro archivo down.sql y dentro de el colocaremos la siguiente línea:\nDROP TABLE IF EXISTS cats; Si no sabes mucho de SQL es sencillo, si la tabla cats existe, si no existe, pues no hacemos nada.\nAhora vayamos al archivo up.sql, aquí es donde debemos escribir las consultas SQL para crear las tablas en la base de datos. En este caso tengo que recalcar una cosa importante, la sintaxis de las consultas puede variar de gestor a gestor, en este caso estamos usando la sintaxis de SQLite, por lo que esto podría NO funcionar en otros motores como MariaDB o PostgreSQL.\nDicho esto, la consulta SQL para crear la tabla necesaria es sencilla, por lo que nuestro archivo up.sql deberá verse así:\nCREATE TABLE IF NOT EXISTS cats ( id INTEGER PRIMARY KEY NOT NULL, name TEXT NOT NULL, photo_url TEXT NOT NULL, is_adopted BOOLEAN NOT NULL, description TEXT NOT NULL ); De nuevo, no hay que ser un genio en SQL para entender lo que hace esta consulta. Si la tabla cats no existe habrá que crearla primero, dentro de ella se creará un id que es un entero que fungirá como llave primaria, los otros campos utilizan las abstracciones de tipos de SQLite3, en este caso TEXT es similar a VARCHAR u otros tipos de dato similares en los manejadores SQL clásicos.\nCuando terminemos de escribir nuestros archivos up.sql y down.sql debemos ejecutar el comando $ diesel migration run. Esto ejecutará los archivos correspondientes para crear / eliminar las tablas de la base de datos. En caso de que algo salga mal, siempre podemos ejecutar el comando $ diesel migration redo para volver a ejecutar las migraciones “desde cero”.\nEn versiones anteriores de Diesel teníamos que ejecutar un comando para imprimir nuestro esquema de la base de datos, si mi memoria no me falla el comando era algo así: diesel print-schema \u003e src/schema.rs . Sin embargo, ahora ese paso no es necesario, este comando se ejecutará de forma automática luego de las migraciones. Si realizamos los pasos correctamente el archivo schema.rs debería verse de la siguiente forma:\ntable! { cats (id) { id -\u003e Integer, name -\u003e Text, photo_url -\u003e Text, is_adopted -\u003e Bool, description -\u003e Text, } } Si todo se generó correctamente, ahora podemos continuar editando nuestro archivo models.rs y añadir los siguientes imports debajo de diesel.\nuse crate::schema::cats; use crate::schema::cats::dsl::cats as all_cats; Como dato importante, no debemos olvidar que debemos añadir mod schema; en nuestro archivo main.rs para incluirlo como módulo en nuestro proyecto de Rust.\nAhora viene una parte interesante. Para manejar las inserciones, modificaciones o eliminaciones de los registros en nuestra base de datos, necesitaremos de una segunda estructura con propiedades insertables y que apunte a un nombre de tabla en específico, solo hace falta copiar nuestra estructura anterior, eliminar el campo de identificación, añadir el prefijo New y un par de atributos por encima de la misma, estos atributos son #[derive(Insertable)] y #[table_name = \"cats\"], en nuestro caso la estructura debería verse así:\n#[derive(Insertable)] #[table_name = \"cats\"] pub struct NewCat { pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } Se lo que estás pensando: “Mi IDE me está diciendo que tengo errores por todos lados”, no te preocupes, esto pasa porque no le hemos indicado a Rust que deseamos utilizar los macros que vienen dentro de Diesel, esto se soluciona fácilmente añadiendo un par de líneas a nuestro archivo main.rs:\n// -- Bibliotecas use std::io; // -- Usar los macros de Diesel #[macro_use] extern crate diesel; // -- Módulos mod models; mod schema; fn main() { println!(\"Hello, world!\"); } Esto debería eliminar los errores de compilación, quedarán un par de warnings, pero iremos eliminándolas poco a poco. Ahora, regresemos a nuestro archivo models.rs para crear los métodos comunes, para esto necesitamos crear una implementación impl para nuestra estructura Cat. Dentro de models.rs crearemos un nuevo bloque de implementación y en las siguientes secciones describiré los métodos que este bloque deberá contener. (No tienen que estar en el mismo orden.) De igual forma, si te pierdes en el proceso recuerda que al final del blog hay un enlace a un repositorio de GitHub donde podrás bajar el proyecto como plantilla, dentro de models.rs abre un nuevo bloque debajo de NewCat:\nimpl Cat { // -- Métodos aquí } NOTA: Algunos métodos regresarán Vectores con datos y, más abajo será muy notorio por que, sin embargo, otros métodos regresarán solo un booleano para saber si la operación fue satisfactoria o no. Si aún no dominas las funciones y sus tipos de retorno en Rust te recomiendo volver a leer el libro.\nEl método show El método show nos permitirá mostrar una entrada de la base de datos en específico basados en el identificador, en pocas palabras nos mostrará los datos de el gato que nosotros necesitemos, siempre y cuando el gato exista y tenga un identificador válido.\nDentro de nuestro bloque impl Cat{...} podemos añadir el método show de la siguiente forma:\npub fn show(id: i32, conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .find(id) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar el gato...\") } Considero que no es necesario explicar la estructura de la función en si, la parte interesante está en la forma de hacer consultas, find() busca por “llave primaria” según la documentación de Diesel, en este caso id lo definimos como una llave primaria en nuestra tabla SQL. Por otra parte load ejecuta una consulta y regresa un vector de resultados, al combinarlos tenemos la consulta completa donde primero buscamos al gato cuyo id sea igual al del parámetro de la función y luego ejecutamos la consulta, regresando un Vector de un solo elemento que en este caso es, el gato consultado.\nNo explicaré la parte del manejo de errores con expect, ya que es similar a unwrap pero con la habilidad de poner un mensaje de error personalizado, puedes leer más al respecto aquí.\nEl método all Este método nos arrojará un vector con todos los registros que tengamos en la base de datos de la estructura que le pedimos, en este caso Cat. El método es el siguiente:\npub fn all(conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .order(cats::id.desc()) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar todos los gatos...\") } Por conveniencia, ordenaremos los gatos de forma descendente por identificador y luego ejecutaremos la consulta.\nEl método update by id Este método nos permitirá actualizar la información de un solo gato siempre y cuando tengamos un identificador del mismo. Su estructura es un poco más compleja que las otras funciones porque requiere de consultar y reescribir todos y cada uno de los campos del gato en cuestión. El método es demasiado largo para explicarlo correctamente sin dar vueltas en múltiples temas, en muy resumidas cuentas, estamos creando una estructura con nuevo gato que reemplazará a al gato que Diesel encuentre en la línea diesel::update(all_cats.find(id)).\nEl método es el siguiente:\npub fn update_by_id(id: i32, conn: \u0026SqliteConnection, cat: NewCat) -\u003e bool { use crate::schema::cats::dsl::{ description as d, is_adopted as i, name as n, photo_url as p, }; let NewCat { name, photo_url, is_adopted, description, } = cat; diesel::update(all_cats.find(id)) .set(( n.eq(name), p.eq(photo_url), i.eq(is_adopted), d.eq(description), )) .execute(conn) .is_ok() } El método insert Insert, como su nombre lo dice nos permitirá insertar un nuevo gato en el registro de nuestra base de datos. El método no tiene mucha ciencia, solo debemos enviar una estructura NewCat al método (ya llena) y el se encargará de crear un nuevo registro en la base de datos con las medidas pertinentes. El método es el siguiente:\npub fn insert(cat: NewCat, conn: \u0026SqliteConnection) -\u003e bool { diesel::insert_into(cats::table) .values(\u0026cat) .execute(conn) .is_ok() } El método delete by id Este método eliminará de la base de datos el gato con el id que solicitemos. Para evitar una operación incorrecta primero revisará si la tabla donde buscamos borrar el gato se encuentra vacía, si lo está simplemente regresará false pues no hay nada que borrar. El método es el siguiente:\npub fn delete_by_id(id: i32, conn: \u0026SqliteConnection) -\u003e bool { if Cat::show(id, conn).is_empty() { return false; }; diesel::delete(all_cats.find(id)).execute(conn).is_ok() } El método all by name El último método nos ayudará a listar múltiples gatos, en caso de que varios tengan el mismo nombre y necesitemos buscar uno en específico o en caso de que necesitemos trabajar con todos los gatos llamados “Misifu”. El método es el siguiente:\npub fn all_by_name(name: String, conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .filter(cats::name.eq(name)) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar los gatos por nombre\") } Con esto podemos dar por terminados los métodos comunes y el “esqueleto” de nuestra REST API. Sin embargo esto aún no termina, aun necesitamos probarla, implementar rocket y sus endpoints para que los métodos nos regresen una respuesta en JSON y crear un pequeño frontend para consumir nuestra API de gatitos.\nNuestro archivo models.rs deberá verse así una vez terminemos de implementar estos métodos:\nuse diesel; use diesel::prelude::*; use diesel::sqlite::SqliteConnection; use crate::schema::cats; use crate::schema::cats::dsl::cats as all_cats; #[derive(Queryable)] pub struct Cat { pub id: i32, pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } #[derive(Insertable)] #[table_name = \"cats\"] pub struct NewCat { pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } impl Cat { pub fn show(id: i32, conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .find(id) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar el gato...\") } pub fn all(conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .order(cats::id.desc()) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar todos los gatos...\") } pub fn update_by_id(id: i32, conn: \u0026SqliteConnection, cat: NewCat) -\u003e bool { use crate::schema::cats::dsl::{ description as d, is_adopted as i, name as n, photo_url as p, }; let NewCat { name, photo_url, is_adopted, description, } = cat; diesel::update(all_cats.find(id)) .set(( n.eq(name), p.eq(photo_url), i.eq(is_adopted), d.eq(description), )) .execute(conn) .is_ok() } pub fn insert(cat: NewCat, conn: \u0026SqliteConnection) -\u003e bool { diesel::insert_into(cats::table) .values(\u0026cat) .execute(conn) .is_ok() } pub fn delete_by_id(id: i32, conn: \u0026SqliteConnection) -\u003e bool { if Cat::show(id, conn).is_empty() { return false; }; diesel::delete(all_cats.find(id)).execute(conn).is_ok() } pub fn all_by_name(name: String, conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .filter(cats::name.eq(name)) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar los gatos por nombre\") } } Probando el ORM Es tiempo de probar nuestro ORM y ver si es capaz de insertar datos correctamente en la base de datos, para ello necesitaremos hacer modificaciones menores a nuestro archivo main.rs, te mostraré como se deberá de ver, no te preocupes, que lo explicaré una vez mostrado el código:\nuse diesel::prelude::*; use diesel::sqlite::SqliteConnection; use dotenv::dotenv; use std::env; #[macro_use] extern crate diesel; mod models; mod schema; fn main() { dotenv().ok(); let database_url = env::var(\"DATABASE_URL\").expect(\"No se encontró la variable DATABASE_URL\"); let conn = SqliteConnection::establish(\u0026database_url).unwrap(); let cat = models::NewCat { name: \"Erina\".to_string(), photo_url: \"/img/posts/api/erina.jpg\".to_string(), is_adopted: true, description: \"Erina es un gato de la raza 'ocicat' adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.\".to_string() }; if models::Cat::insert(cat, \u0026conn) { println!(\"Se registró el gato correctamente\"); } else { println!(\"No se pudo añadir el gato a la base de datos\"); } } Primero lo primero importamos las cosas necesarias. Dentro de la función main tenemos dotenv().ok(), de acuerdo a la documentación de dotenv, esto es todo lo que necesitamos para que la biblioteca lea el archivo .env que creamos antes y la cargue en memoria. Luego tenemos la variable database_url que utiliza std::env para leer una variable de entorno y guardarla como un String si es que la encuentra, en caso de no encontrarla el programa se detendrá y Rust nos enviará un error informándonos que dicha variable no se encontró.\nLa variable conn la utilizamos para crear una conexión a la base de datos Sqlite que creamos antes, esta se realiza utilizando la variable database_url, como regresa un Result podemos (aunque no es recomendado) utilizar el método unwrap, pues, si todo va bien no es necesario reportar nada, pero si falla, no tiene sentido continuar con la ejecución del programa, por lo tanto Rust hará que el programa falle directamente y termine su ejecución.\nDebajo creamos una variable cat la cual solo es una estructura NewCat con los datos de un gato, en mi caso utilicé a mi gata Erina como prueba. Debajo de la declaración solo creamos una condicional para ver si la inserción en la base de datos fue realizada correctamente.\nSi seguimos estos pasos al pie de la letra deberíamos poder ejecutar el comando $ cargo run y obtener la siguiente salida:\nwarning: `rest-rust-template` (bin \"rest-rust-template\") generated 5 warnings Finished dev [unoptimized + debuginfo] target(s) in 0.67s Running `target/debug/rest-rust-template` Se registró el gato correctamente Véase la última línea: Se registró el gato correctamente. Para comprobar esto utilizaré la herramienta sqlite browser para revisar la base de datos y comprobar que en efecto, Erina fue registrada correctamente:\n¡Perfecto! Nuestros métodos de inserción funcionan. Ahora tomemos el camino riesgoso y comencemos a modificar nuestra API como bestias sin haber probado los otros métodos.\nAñadiendo rocket con soporte para JSON Si tienes buena memoria recordarás que, en nuestro archivo Cargo.toml ya colocamos r2d2 como “feature” de Diesel en su momento, esto con la finalidad de evitar esa mala práctica de importar una nueva versión de una biblioteca cuando no es requerida forzosamente. Ahora haremos lo mismo con Rocket, normalmente se añade rocket, serde, serde-json y otras dependencias al archivo Cargo.toml, gracias al cielo con Rocket v0.5-rc1 esto ya no pasa, pues el soporte para JSON viene como feature y las crates de rocket_codegen y rocket_contrib ya se encuentran deprecated.\nSolo es necesario añadir una línea con los features que deseamos incluir en nuestro proyecto, en este caso necesitamos de las features de JSON para que nuestra REST API pueda enviarnos los datos codificados como JSON a través de sus endpoints. Solo hay que añadir la línea rocket = { version = \"0.5.0-rc.1\", features = [ \"json\" ] } a nuestro archivo Cargo.toml y tenemos todo para ganar.\nHecho esto es recomendable volver a ejecutar $cargo build para que Cargo descargue y compile las dependencias necesarias para Rocket.\nImplementando r2d2 Por el momento nuestra API funciona correctamente, sin embargo tiene un pequeño problema. Establecer una nueva conexión a una base de datos cada vez que necesitamos consumir datos de la misma es ineficiente y pesado en recursos, esto (por experiencia) puede hacer que la máquina que está ejecutando nuestro servidor comience a fallar, que salte el demonio EarlyOOM y mate procesos que considere innecesarios (a veces mata cosas importantes) o que simplemente el servidor colapse por falta de recursos.\nPara solucionar este problema existe r2d2 el cual podría definirse como un “manejador de conexiones” para las bases de datos.\nLa implementación es corta, no es sencilla y explicarla es complejo.\nPara serte sincero, ni yo tengo idea de que es lo que hice en ese momento, tuve que experimentar mucho con los genéricos, tutoriales y documentación sobre traits en Rust para llegar a un resultado que funcione bien.\nPrimero debemos crear un archivo llamado db.rs en el mismo directorio donde se encuentra nuestro archivo main.rs (No olvides incluirlo como módulo dentro de main.rs usando mod db;), una vez incluido como módulo debemos añadir los siguientes imports al inicio del archivo:\nuse diesel::r2d2::ConnectionManager; use diesel::sqlite::SqliteConnection; use rocket::http::Status; use rocket::outcome::try_outcome; use rocket::outcome::Outcome; use rocket::request::{self, FromRequest}; use rocket::{Request, State}; use std::ops::Deref; Para ahorrarnos un par de errores en el futuro también es conveniente añadir estas líneas a nuestro archivo main.rs debajo del uso de macros de Diesel:\n#[macro_use] extern crate rocket; En caso de que estés perdido en este punto, nuestro archivo main.rs deberá verse así:\nuse diesel::prelude::*; use diesel::sqlite::SqliteConnection; use dotenv::dotenv; use std::env; #[macro_use] extern crate diesel; //-- Esto fue lo que añadimos #[macro_use] extern crate rocket; //-- mod db; mod models; mod schema; fn main() { dotenv().ok(); let database_url = env::var(\"DATABASE_URL\").expect(\"No se encontró la variable DATABASE_URL\"); let conn = SqliteConnection::establish(\u0026database_url).unwrap(); let cat = models::NewCat { name: \"Erina\".to_string(), photo_url: \"/img/posts/api/erina.jpg\".to_string(), is_adopted: true, description: \"Erina es un gato de la raza 'ocicat' adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.\".to_string() }; if models::Cat::insert(cat, \u0026conn) { println!(\"Se registró el gato correctamente\"); } else { println!(\"No se pudo añadir el gato a la base de datos\"); } } Ahora si, de vuelta a nuestro archivo db.rs.\nDentro del mismo haremos un “wrapper” para un manejador de conexiones utilizando la versión de r2d2 que viene con Diesel, una función de inicialización de manejo de conexiones y finalmente un par de traits para terminar la implementación.\nComo dije anteriormente, este archivo es un poco complejo de explicar y este blog ya es de por si bastante largo, sin embargo no te dejaré con la curiosidad, aquí tienes algunos recursos que utilicé para esto:\nEl trait FromRequest de Rocket “Guards” con Rocket Primeros pasos con Rocket y r2d2 La implementación de r2d2 de Diesel Con esta información servida, el archivo db.rs debería verse así:\nNOTA: Esto está diseñado para trabajar con bases de datos SQLite, con cosas como PostgreSQL y/o MySQL/MariaDB tus resultados podrían variar, así que deberás modificar esto de acuerdo a tus necesidades\nuse diesel::r2d2::ConnectionManager; use diesel::sqlite::SqliteConnection; use rocket::http::Status; use rocket::outcome::try_outcome; use rocket::outcome::Outcome; use rocket::request::{self, FromRequest}; use rocket::{Request, State}; use std::ops::Deref; // Create a wrapper for the r2d2 Pool object pub type Pool = diesel::r2d2::Pool\u003cConnectionManager\u003cSqliteConnection\u003e\u003e; pub fn init_pool(db_url: String) -\u003e Pool { let manager = ConnectionManager::\u003cSqliteConnection\u003e::new(db_url); diesel::r2d2::Pool::new(manager).expect(\"Failed to init database pool!\") } // Create a guard for our database connection pub struct Conn(pub diesel::r2d2::PooledConnection\u003cConnectionManager\u003cSqliteConnection\u003e\u003e); #[rocket::async_trait] impl\u003c'r\u003e FromRequest\u003c'r\u003e for Conn { type Error = (); async fn from_request(request: \u0026'r Request\u003c'_\u003e) -\u003e request::Outcome\u003cConn, ()\u003e { let pool = try_outcome!(request.guard::\u003c\u0026State\u003cPool\u003e\u003e().await); match pool.get() { Ok(conn) =\u003e Outcome::Success(Conn(conn)), Err(_) =\u003e Outcome::Failure((Status::ServiceUnavailable, ())), } } } impl Deref for Conn { type Target = SqliteConnection; // Rust already inlines this, no need to specify the previous decorator. fn deref(\u0026self) -\u003e \u0026Self::Target { \u0026self.0 } } Antes de implementar nuestros métodos en db.rs tenemos que regresar a nuestro archivo models.rs para implementar Serde y así poder codificar nuestras estructuras en JSON.\nDentro de models.rs en la parte de los imports necesitamos añadir dos líneas extra, una para el serializador y otra para el deserializador:\nuse rocket::serde::Deserialize; use rocket::serde::Serialize; Debajo, en la estructura Cat modificaremos el atributo derive para añadir los atributos Serialize, Debug y Clone.\nNOTA: Es probable que, si incluyes estos atributos, Cargo te arroje un error: error[E0463]: can't find crate for serde, esto ocurre por una regla de Rust llamada “Rust Orphan Rule”. El fix es sencillo, solo hace falta añadir un atributo extra debajo de derive\nDe igual forma modificaremos la estructura NewCat, para no alargarme demasiado ambas estructuras deberán verse así:\n#[derive(Serialize, Queryable, Debug, Clone)] #[serde(crate = \"rocket::serde\")] pub struct Cat { pub id: i32, pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } #[derive(Insertable, Serialize, Deserialize)] #[serde(crate = \"rocket::serde\")] #[table_name = \"cats\"] pub struct NewCat { pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } Con esto la serialización y deserialización de nuestras estructuras en JSON está “casi” completa.\nEs tiempo de implementar nuestro manejador de conexiones de bases de datos junto con rocket en nuestro archivo main.rs\nRocket y las rutas Para comenzar con Rocket es necesario modificar nuestra función main. Hay muchas formas de hacer esto según la documentación de Rocket, sin embargo yo recomiendo que eliminemos lo poco que tenemos en la función main y lo reemplazemos por esto:\n#[get(\"/\")] fn index() -\u003e \u0026'static str { \"Hello, world!\" } #[launch] fn rocket() -\u003e _ { rocket::build().mount(\"/\", routes![index]) } Solo debemos restaurar dos líneas para que el funcionamiento se acerque a lo que teníamos antes (no te preocupes por la prueba de inserción de datos, eso lo manejaremos más tarde), podemos aprovechar para utilizar nuestro manejador de conexiones de bases de datos en db.rs aquí:\n#[launch] fn rocket() -\u003e _ { dotenv().ok(); let db_url: String = env::var(\"DATABASE_URL\").expect(\"set DATABASE_URL\"); // -- Se añadió esta linea let pool = db::init_pool(db_url); // -- rocket::build().mount(\"/\", routes![index]) } Manejando archivos estáticos Algo que nos sería de mucha utilidad sería una ruta para manejar los archivos estáticos y servirlos si son requeridos por el usuario. Para esto es necesario repetir el paso donde creamos un módulo. En el mismo directorio donde se encuentra main.rs debemos crear un archivo llamado static_files.rs y lo incluimos en main.rs con la línea mod static_files;.\nDentro de static_files.rs colocaremos el siguiente código:\nuse rocket::fs::NamedFile; use std::io; use std::path::{Path, PathBuf}; #[get(\"/\")] pub async fn index() -\u003e io::Result\u003cNamedFile\u003e { NamedFile::open(\"public/index.html\").await } #[get(\"/\", rank = 5)] pub async fn all(file: PathBuf) -\u003e Option\u003cNamedFile\u003e { NamedFile::open(Path::new(\"public/\").join(file)).await.ok() } La primer función utiliza un macro declarativo y fungirá como el índice de nuestra página web servida con Rocket. Esta función index regresará un resultado con un archivo, el archivo en cuestión es un index.html dentro del directorio public/.\nAsimismo en la función debajo hace algo similar, solo que utilizará los macros declarativos para servir archivos estáticos, en este caso todos los que se encuentren en el directorio public/.\nPor el momento no crearemos ningún archivo estático. Recuerda que al inicio del tutorial dije que utilizaríamos Svelte como framework de JavaScript para ejemplificar como consumir esta pequeña API.\nAhora debemos añadir nuestras rutas estáticas a la función rocket en nuestro archivo main.rs, con las rutas añadidas la función rocket ahora debería verse así:\n#[launch] fn rocket() -\u003e _ { dotenv().ok(); let db_url: String = env::var(\"DATABASE_URL\").expect(\"set DATABASE_URL\"); let pool = db::init_pool(db_url); rocket::build().mount( \"/\", routes![crate::static_files::all, crate::static_files::index], ) } Creando los endpoints Casi hemos terminado nuestra REST API, nos falta una parte muy importante que son los endpoints, estos devolverán una respuesta diferente dependiendo de la petición HTTP que les enviemos (GET, POST, UPDATE, DELETE, etc) o no enviarán nada. Para comenzar a desarrollar nuestros endpoints debemos crear un archivo routes.rs en el mismo directorio donde se encuentra nuestro archivo main.rs y añadirlo como módulo usando la línea mod routes;.\nDentro de nuestro archivo routes.rs debemos incluir los siguientes imports:\nuse crate::db::Conn as DbConn; use crate::models::{Cat, NewCat}; use rocket::serde::json::{json, Json, Value}; Endpoint: index La primera cosa que implementaremos en nuestra API será un endpoint que nos permitirá sacar toda la información de nuestra base de datos en una sola operación. Rocket nos puede ayudar con el uso de atributos, en este caso atributos especiales para manejo de rutas y respuestas:\n#[get(\"/cats\", format = \"application/json\")] pub fn index(conn: DbConn) -\u003e Json\u003cValue\u003e { let cats: Vec\u003cCat\u003e = Cat::all(\u0026conn); Json(json!({ \"status\": 200, \"result\": cats, })) } La función hará una conexión a nuestra base de datos y regresará los datos ya formateados como JSON, dentro del JSON regresaremos dos cosas, el código de salida (200 en caso de que todo vaya bien) y \"result\" que será un arreglo enorme con todos los gatos que tengamos registrados en nuestra base de datos.\nEndpoint: new Ahora necesitamos crear un endpoint que nos permita crear un nuevo gato si es necesario:\n#[post(\"/cats\", format = \"application/json\", data = \"\")] pub fn new(conn: DbConn, new_cat: Json\u003cNewCat\u003e) -\u003e Json\u003cValue\u003e { Json(json!({ \"status\": Cat::insert(new_cat.into_inner(), \u0026conn), \"result\": Cat::all(\u0026conn).first(), })) } El atributo que usaremos esta vez sirve para procesar peticiones POST, de igual forma la respuesta será en formato JSON, con la diferencia que ahora tendremos un campo nuevo llamado data el cual guardará un nuevo gato, en nuestro caso es el gato que guardaremos en la base de datos. Esta función nos devolverá un JSON con el estatus de salida de la inserción del gato y el resultado que es el mismo gato que acabamos de insertar en la base de datos.\nEndpoint: show Ahora ¿Qué pasa si necesitamos consultar un gato en específico? Simple, ahora necesitamos hacer un endpoint que nos permita hacer eso mismo, en esta caso lo llamaremos show:\n#[get(\"/cats/\", format = \"application/json\")] pub fn show(conn: DbConn, id: i32) -\u003e Json\u003cValue\u003e { let result: Vec\u003cCat\u003e = Cat::show(id, \u0026conn); let status: i32 = if result.is_empty() { 404 } else { 200 }; Json(json!({ \"status\": status, \"result\": result.get(0), })) } Este endpoint vuelve a hacer uso del macro GET, solo que en este caso utiliza las directivas especiales de las rutas de Rocket, llamadas Dynamic Paths (mas información aquí). Con esto podemos consultar el ID de un gato en específico y Rocket sabrá dirigirnos al mismo, lo mejor de todo es que nos devolverá el gato ya codificado como JSON.\nEndpoint: update ¿Registraste mal un gato? ¿Alguien ya lo adoptó? Para eso podemos crear un endpoint update:\n#[put(\"/cats/\", format = \"application/json\", data = \"\")] pub fn update(conn: DbConn, id: i32, cat: Json\u003cNewCat\u003e) -\u003e Json\u003cValue\u003e { let status: i32 = if Cat::update_by_id(id, \u0026conn, cat.into_inner()) { 200 } else { 404 }; Json(json!({ \"status\": status, \"result\": null, })) } Empiezo a pensar que todas las cosas que impliquen un update siempre serán un despelote….¯\\_(ツ)_/¯ anyways.\nEste método necesitará que le digamos en la URI el ID del gato que deseamos actualizar, para esto será necesario enviar un nuevo gato. La condicional en el JSON devuelto dependerá de la salida del comando de actualización. Si el gato pudo actualizarse correctamente el status de salida será un 200, en cualquier otro caso devolveremos un error 404 (Es recomendable manejar los errores mejor de lo que yo lo hice, pues una actualización no solo podría fallar por no encontrar un gato, si no por un error de servidor).\nEndpoint: delete Casi hemos terminado, ahora necesitamos un endpoint para eliminar un gato de la base de datos en caso de que lo necesitemos.\n#[delete(\"/cats/\")] pub fn delete(id: i32, conn: DbConn) -\u003e Json\u003cValue\u003e { let status: i32 = if Cat::delete_by_id(id, \u0026conn) { 200 } else { 404 }; Json(json!({ \"status\": status, \"result\": null, })) } Este endpoint hace uso del atributo delete y al igual que los anteriores, requiere del ID de un gato específico para que lo borre de nuestra base de datos. El modo de regresar el status es similar al del endpoint update y de nuevo lo recalcaré, recomiendo hacer un mejor manejo de errores.\nEndpoint: name Finalmente, en caso de que necesitemos consultar todos los gatos con un nombre en específico podemos crear un endpoint name para ello:\n#[get(\"/cats/names/\", format = \"application/json\")] pub fn name(name: String, conn: DbConn) -\u003e Json\u003cValue\u003e { Json(json!({ \"status\": 200, \"result\": Cat::all_by_name(name, \u0026conn), })) } Este endpoint llamará a la función all_by_name y nos devolverá un solo JSON con todos los gatos que compartan el mismo nombre. En este caso no manejé errores por flojo, no hagas eso tu también. Con este último endpoint nuestro archivo routes.rs debería estar terminado, en caso de que te hayas perdido el resultado final debería verse así:\nuse crate::db::Conn as DbConn; use crate::models::{Cat, NewCat}; use rocket::serde::json::{json, Json, Value}; #[get(\"/cats\", format = \"application/json\")] pub fn index(conn: DbConn) -\u003e Json\u003cValue\u003e { let cats: Vec\u003cCat\u003e = Cat::all(\u0026conn); Json(json!({ \"status\": 200, \"result\": cats, })) } #[post(\"/cats\", format = \"application/json\", data = \"\")] pub fn new(conn: DbConn, new_cat: Json\u003cNewCat\u003e) -\u003e Json\u003cValue\u003e { Json(json!({ \"status\": Cat::insert(new_cat.into_inner(), \u0026conn), \"result\": Cat::all(\u0026conn).first(), })) } #[get(\"/cats/\", format = \"application/json\")] pub fn show(conn: DbConn, id: i32) -\u003e Json\u003cValue\u003e { let result: Vec\u003cCat\u003e = Cat::show(id, \u0026conn); let status: i32 = if result.is_empty() { 404 } else { 200 }; Json(json!({ \"status\": status, \"result\": result.get(0), })) } #[put(\"/cats/\", format = \"application/json\", data = \"\")] pub fn update(conn: DbConn, id: i32, cat: Json\u003cNewCat\u003e) -\u003e Json\u003cValue\u003e { let status: i32 = if Cat::update_by_id(id, \u0026conn, cat.into_inner()) { 200 } else { 404 }; Json(json!({ \"status\": status, \"result\": null, })) } #[delete(\"/cats/\")] pub fn delete(id: i32, conn: DbConn) -\u003e Json\u003cValue\u003e { let status: i32 = if Cat::delete_by_id(id, \u0026conn) { 200 } else { 404 }; Json(json!({ \"status\": status, \"result\": null, })) } #[get(\"/cats/names/\", format = \"application/json\")] pub fn name(name: String, conn: DbConn) -\u003e Json\u003cValue\u003e { Json(json!({ \"status\": 200, \"result\": Cat::all_by_name(name, \u0026conn), })) } Montando los endpoints Casi hemos terminado nuestra REST API, solo queda montar los endpoints de nuestra API, para hacer esto solo tenemos que repetir el paso donde incluimos una función mount() en nuestro archivo main.rs, en este caso, montaremos nuestra API bajo la ruta /api/ arriba de la ruta “/” . También podemos borrar el método GET que tenemos arriba de la función principal de Rocket:\n#[launch] fn rocket() -\u003e _ { dotenv().ok(); let db_url: String = env::var(\"DATABASE_URL\").expect(\"set DATABASE_URL\"); let pool = db::init_pool(db_url); rocket::build() .manage(pool) .mount( \"/api/\", routes![ crate::routes::index, crate::routes::new, crate::routes::show, crate::routes::delete, crate::routes::name, crate::routes::update ], ) .mount( \"/\", routes![crate::static_files::all, crate::static_files::index], ) } Archivos finales Si te perdiste en el proceso y deseas saber como se ven los archivos en este punto, no te preocupes, debajo podrás leer en un subtítulo el nombre del archivo y como debería verse llegados a este punto.\nsrc/main.rs El archivo principal debería verse así:\nuse diesel::prelude::*; use diesel::sqlite::SqliteConnection; use dotenv::dotenv; use std::env; #[macro_use] extern crate diesel; #[macro_use] extern crate rocket; mod db; mod models; mod routes; mod schema; mod static_files; #[launch] fn rocket() -\u003e _ { dotenv().ok(); let db_url: String = env::var(\"DATABASE_URL\").expect(\"set DATABASE_URL\"); let pool = db::init_pool(db_url); rocket::build() .manage(pool) .mount( \"/api/\", routes![ crate::routes::index, crate::routes::new, crate::routes::show, crate::routes::delete, crate::routes::name, crate::routes::update ], ) .mount( \"/\", routes![crate::static_files::all, crate::static_files::index], ) } src/models.rs El archivo de los modelos de la base de datos deberá verse así:\nuse diesel; use diesel::prelude::*; use diesel::sqlite::SqliteConnection; use rocket::serde::Deserialize; use rocket::serde::Serialize; use crate::schema::cats; use crate::schema::cats::dsl::cats as all_cats; #[derive(Serialize, Queryable, Debug, Clone)] #[serde(crate = \"rocket::serde\")] pub struct Cat { pub id: i32, pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } #[derive(Insertable, Serialize, Deserialize)] #[serde(crate = \"rocket::serde\")] #[table_name = \"cats\"] pub struct NewCat { pub name: String, pub photo_url: String, pub is_adopted: bool, pub description: String, } impl Cat { pub fn show(id: i32, conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .find(id) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar el gato...\") } pub fn all(conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .order(cats::id.desc()) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar todos los gatos...\") } pub fn update_by_id(id: i32, conn: \u0026SqliteConnection, cat: NewCat) -\u003e bool { use crate::schema::cats::dsl::{ description as d, is_adopted as i, name as n, photo_url as p, }; let NewCat { name, photo_url, is_adopted, description, } = cat; diesel::update(all_cats.find(id)) .set(( n.eq(name), p.eq(photo_url), i.eq(is_adopted), d.eq(description), )) .execute(conn) .is_ok() } pub fn insert(cat: NewCat, conn: \u0026SqliteConnection) -\u003e bool { diesel::insert_into(cats::table) .values(\u0026cat) .execute(conn) .is_ok() } pub fn delete_by_id(id: i32, conn: \u0026SqliteConnection) -\u003e bool { if Cat::show(id, conn).is_empty() { return false; }; diesel::delete(all_cats.find(id)).execute(conn).is_ok() } pub fn all_by_name(name: String, conn: \u0026SqliteConnection) -\u003e Vec\u003cCat\u003e { all_cats .filter(cats::name.eq(name)) .load::\u003cCat\u003e(conn) .expect(\"Ocurrió un error al cargar los gatos por nombre\") } } src/routes.rs El archivo de rutas (endpoints) de nuestra API deberá verse así:\nuse crate::db::Conn as DbConn; use crate::models::{Cat, NewCat}; use rocket::serde::json::{json, Json, Value}; #[get(\"/cats\", format = \"application/json\")] pub fn index(conn: DbConn) -\u003e Json\u003cValue\u003e { let cats: Vec\u003cCat\u003e = Cat::all(\u0026conn); Json(json!({ \"status\": 200, \"result\": cats, })) } #[post(\"/cats\", format = \"application/json\", data = \"\")] pub fn new(conn: DbConn, new_cat: Json\u003cNewCat\u003e) -\u003e Json\u003cValue\u003e { Json(json!({ \"status\": Cat::insert(new_cat.into_inner(), \u0026conn), \"result\": Cat::all(\u0026conn).first(), })) } #[get(\"/cats/\", format = \"application/json\")] pub fn show(conn: DbConn, id: i32) -\u003e Json\u003cValue\u003e { let result: Vec\u003cCat\u003e = Cat::show(id, \u0026conn); let status: i32 = if result.is_empty() { 404 } else { 200 }; Json(json!({ \"status\": status, \"result\": result.get(0), })) } #[put(\"/cats/\", format = \"application/json\", data = \"\")] pub fn update(conn: DbConn, id: i32, cat: Json\u003cNewCat\u003e) -\u003e Json\u003cValue\u003e { let status: i32 = if Cat::update_by_id(id, \u0026conn, cat.into_inner()) { 200 } else { 404 }; Json(json!({ \"status\": status, \"result\": null, })) } #[delete(\"/cats/\")] pub fn delete(id: i32, conn: DbConn) -\u003e Json\u003cValue\u003e { let status: i32 = if Cat::delete_by_id(id, \u0026conn) { 200 } else { 404 }; Json(json!({ \"status\": status, \"result\": null, })) } #[get(\"/cats/names/\", format = \"application/json\")] pub fn name(name: String, conn: DbConn) -\u003e Json\u003cValue\u003e { Json(json!({ \"status\": 200, \"result\": Cat::all_by_name(name, \u0026conn), })) } src/static_files.rs El archivo para manejar archivos estáticos en Rocket deberá verse así:\nuse rocket::fs::NamedFile; use std::io; use std::path::{Path, PathBuf}; #[get(\"/\")] pub async fn index() -\u003e io::Result\u003cNamedFile\u003e { NamedFile::open(\"public/index.html\").await } #[get(\"/\", rank = 5)] pub async fn all(file: PathBuf) -\u003e Option\u003cNamedFile\u003e { NamedFile::open(Path::new(\"public/\").join(file)).await.ok() } src/schema.rs El archivo autogenerado por Diesel deberá verse así:\ntable! { cats (id) { id -\u003e Integer, name -\u003e Text, photo_url -\u003e Text, is_adopted -\u003e Bool, description -\u003e Text, } } Probando nuestra REST API Llegó el momento de la verdad, guardemos cambios y ejecutemos $ cargo run en nuestra terminal y observar la magia:\nSi ponemos atención a la sección que dice: 🛰 Routes: podemos darnos cuenta de que todas nuestras rutas existen y parece que funcionan. Sin embargo no sabremos esto hasta hacer unas pruebas con la herramienta más poderosa que existe para probar REST API: curl.\nEn una nueva terminal intentemos ejecutar la siguiente orden:\ncurl -v http://127.0.0.1:8000/api/cats/ La salida de la terminal debería ser:\n* Trying 127.0.0.1:8000... * Connected to 127.0.0.1 (127.0.0.1) port 8000 (#0) \u003e GET /api/cats/ HTTP/1.1 \u003e Host: 127.0.0.1:8000 \u003e User-Agent: curl/7.74.0 \u003e Accept: */* \u003e * Mark bundle as not supporting multiuse \u003c HTTP/1.1 200 OK \u003c content-type: application/json \u003c server: Rocket \u003c permissions-policy: interest-cohort=() \u003c x-frame-options: SAMEORIGIN \u003c x-content-type-options: nosniff \u003c content-length: 567 \u003c date: Sun, 30 Jan 2022 05:29:32 GMT \u003c * Connection #0 to host 127.0.0.1 left intact {\"result\":[{\"description\":\"Erina es un gato de la raza 'ocicat' adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.\",\"id\":2,\"is_adopted\":true,\"name\":\"Erina\",\"photo_url\":\"/img/posts/api/erina.jpg\"},{\"description\":\"Erina es un gato de la raza 'ocicat' adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.\",\"id\":1,\"is_adopted\":true,\"name\":\"Erina\",\"photo_url\":\"/img/posts/api/erina.jpg\"}],\"status\":200} Si miramos la pantalla de Rocket podremos ver que la salida muestra nuevas líneas:\nGET /api/cats/: \u003e\u003e Matched: (index) GET /api/cats application/json \u003e\u003e Outcome: Success \u003e\u003e Response succeeded. ¡Perfecto! Ahora probemos si podemos insertar un nuevo gato con la siguiente orden de curl:\ncurl -d '{ \"id\":3, \"name\":\"Erino\", \"photo_url\":\"/img/posts/api/erino.jpeg\", \"is_adopted\":true, \"description\":\"Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado\" }' -H 'Content-Type: application/json' http://127.0.0.1:8000/api/cats La salida de la terminal debería ser la siguiente:\n{\"result\":{\"description\":\"Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado\",\"id\":3,\"is_adopted\":true,\"name\":\"Erino\",\"photo_url\":\"/img/posts/api/erino.jpeg\"},\"status\":true} Ahora comprobemos si nuestro gato nuevo fue registrado con éxito, con la primer orden que hicimos:\ncurl -v http://127.0.0.1:8000/api/cats/ ~* Trying 127.0.0.1:8000...* Connected to 127.0.0.1 (127.0.0.1) port 8000 (#0) \u003e GET /api/cats/ HTTP/1.1 \u003e Host: 127.0.0.1:8000 \u003e User-Agent: curl/7.74.0 \u003e Accept: */* \u003e * Mark bundle as not supporting multiuse \u003c HTTP/1.1 200 OK \u003c content-type: application/json \u003c server: Rocket \u003c permissions-policy: interest-cohort=() \u003c x-frame-options: SAMEORIGIN \u003c x-content-type-options: nosniff \u003c content-length: 832 \u003c date: Sun, 30 Jan 2022 05:50:28 GMT \u003c * Connection #0 to host 127.0.0.1 left intact {\"result\":[{\"description\":\"Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado\",\"id\":3,\"is_adopted\":true,\"name\":\"Erino\",\"photo_url\":\"/img/posts/api/erino.jpeg\"},{\"description\":\"Erina es un gato de la raza 'ocicat' adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.\",\"id\":2,\"is_adopted\":true,\"name\":\"Erina\",\"photo_url\":\"/img/posts/api/erina.jpg\"},{\"description\":\"Erina es un gato de la raza 'ocicat' adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.\",\"id\":1,\"is_adopted\":true,\"name\":\"Erina\",\"photo_url\":\"/img/posts/api/erina.jpg\"}],\"status\":200} Espera…¿Hay dos “Erina” registadas? Eso es inadmisible, Erina solo hay una. Tendremos que borrar al impostor:\ncurl -X DELETE http://127.0.0.1:8000/api/cats/2 Comprobemos si la Erina impostora se eliminó correctamente:\ncurl -v http://127.0.0.1:8000/api/cats/ ~* Trying 127.0.0.1:8000...* Connected to 127.0.0.1 (127.0.0.1) port 8000 (#0) \u003e GET /api/cats/ HTTP/1.1 \u003e Host: 127.0.0.1:8000 \u003e User-Agent: curl/7.74.0 \u003e Accept: */* \u003e * Mark bundle as not supporting multiuse \u003c HTTP/1.1 200 OK \u003c content-type: application/json \u003c server: Rocket \u003c permissions-policy: interest-cohort=() \u003c x-frame-options: SAMEORIGIN \u003c x-content-type-options: nosniff \u003c content-length: 561 \u003c date: Sun, 30 Jan 2022 05:54:35 GMT \u003c * Connection #0 to host 127.0.0.1 left intact {\"result\":[{\"description\":\"Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado\",\"id\":3,\"is_adopted\":true,\"name\":\"Erino\",\"photo_url\":\"/img/posts/api/erino.jpeg\"},{\"description\":\"Erina es un gato de la raza 'ocicat' adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.\",\"id\":1,\"is_adopted\":true,\"name\":\"Erina\",\"photo_url\":\"/img/posts/api/erina.jpg\"}],\"status\":200} Creando un frontend para nuestra API ¡Perfecto! Ahora que nuestra API funciona, vamos a integrar un frontend para consumir los datos. En nuestro caso usaremos el framework Svelte. Para ello, podemos descomprimir el código proporcionado por Svelte. (Lo puedes descargar aquí) Solo es necesario presionar el botón “Code” y luego presionar el botón “Download Zip”.\nPodríamos usar la herramienta degit pero sinceramente, no le veo un uso práctico más alla ser un git clone --depth=1 hecho en JS.\nColocamos el código descomprimido en el directorio donde tenemos el proyecto de Rust. Antes de ello, cambiaremos el nombre de la carpeta src de la plantilla de Svelte a algo como frontend para evitar conflictos con el directorio src de Rust.\nAntes de continuar, debemos modificar el archivo rollup.config.js para indicarle que frontend/ será nuestro nuevo directorio donde guardaremos el frontend de nuestra aplicación web. Si necesitas ayuda te dejo mi archivo rollup.config.js final para que lo tomes como guía:\nimport svelte from 'rollup-plugin-svelte'; import commonjs from '@rollup/plugin-commonjs'; import resolve from '@rollup/plugin-node-resolve'; import livereload from 'rollup-plugin-livereload'; import { terser } from 'rollup-plugin-terser'; import css from 'rollup-plugin-css-only'; const production = !process.env.ROLLUP_WATCH; function serve() { let server; function toExit() { if (server) server.kill(0); } return { writeBundle() { if (server) return; server = require('child_process').spawn('npm', ['run', 'start', '--', '--dev'], { stdio: ['ignore', 'inherit', 'inherit'], shell: true }); process.on('SIGTERM', toExit); process.on('exit', toExit); } }; } export default { input: 'frontend/main.js', output: { sourcemap: true, format: 'iife', name: 'app', file: 'public/build/bundle.js' }, plugins: [ svelte({ compilerOptions: { // enable run-time checks when not in production dev: !production } }), // we'll extract any component CSS out into // a separate file - better for performance css({ output: 'bundle.css' }), // If you have external dependencies installed from // npm, you'll most likely need these plugins. In // some cases you'll need additional configuration - // consult the documentation for details: // https://github.com/rollup/plugins/tree/master/packages/commonjs resolve({ browser: true, dedupe: ['svelte'] }), commonjs(), // In dev mode, call `npm run start` once // the bundle has been generated !production \u0026\u0026 serve(), // Watch the `public` directory and refresh the // browser on changes when not in production !production \u0026\u0026 livereload('public'), // If we're building for production (npm run build // instead of npm run dev), minify production \u0026\u0026 terser() ], watch: { clearScreen: false } }; Perfecto. Ahora para terminar metemos todo el contenido de la plantilla de Svelte en nuestro proyecto de la REST API de Rust:\ntree -L 1 rest-rust-template -\u003e master ? . ├── Cargo.lock ├── Cargo.toml ├── debug.db ├── diesel.toml ├── frontend ├── migrations ├── package.json ├── public ├── README.md ├── rollup.config.js ├── scripts ├── src └── target 6 directories, 7 files Si tu estructura de directorios es similar, entonces todo perfecto. Solo falta un último paso antes de comenzar con el frontend, hay que añadir las siguientes líneas al archivo .gitignore:\n/node_modules/ /public/build/ .DS_Store Perfecto, con eso evitaremos subir cosas que no necesitamos al repositorio de git.\nComenzando con Svelte Nota: Recuerda encender el servidor de Rocket con $cargo run para acceder a los recursos de la API\nDentro de nuestro directorio del proyecto ejecutaremos la orden $ npm install \u0026\u0026 npm run dev para comenzar con la instalación de dependencias y la vista en vivo de nuestro proyecto con NodeJS.\nCuando la terminal lo indique, se nos entregará una URL para revisar el progreso de nuestra aplicación de Svelte, en mi caso la URL es: http://localhost:8080. Si entramos a esta URL en nuestro navegador preferido obtendremos una pantalla así:\nTengo que decir que yo no soy un desarrollador frontend (ni deseo serlo realmente) por lo que la interfaz que voy a construir es por mucho, muy fea.\nDentro de nuestro proyecto de Svelte entraremos a editar el archivo App.svelte. Aquí ocurrirá toda la magia.\nDentro de App.svelte podemos ver que ya hay contenido, sugiero borrar todo lo que hay dentro y colocar esto en su lugar:\n\u003cscript charset=\"utf-8\"\u003e \u003c/script\u003e \u003cstyle type=\"text/css\" media=\"screen\"\u003e \u003c/style\u003e \u003cmain\u003e \u003c/main\u003e Con esto tendremos un marco de trabajo para comenzar con el proyecto. Antes de comenzar a programar nada debo decir que el enfoque de SvelteJS es hacer interfaces con un framework sencillo pero completo y sobre todo enfocado en hacer componentes.\nEn este caso no estoy creando componentes por simplicidad, sin embargo en proyectos más serios desapruebo encarecidamente hacer todo dentro de App.svelte.\nCon esta advertencia hecha, ahora si. Vamos a programar la parte de JavaScript que nos entregará a nuestros gatos registrados, dentro de las etiquetas script colocaremos el siguiente código:\n// URL del API de los gatitos const api_url = 'http://127.0.0.1:8000/api/cats'; // Obtener información del API const fetchCats = (async () =\u003e { const response = await fetch(api_url) return await response.json() })() Este pequeño trozo de código lo que hará es definir la URL donde nuestro servidor de Rocket está ejecutándose. Lo segundo es una constante que es (con mi conocimiento límitado del desmadre de lenguaje que es JavaScript) el resultado del uso del API fetch de JavaScript. Honestamente no sabría explicar esas líneas de código a detalle, si eres un conocedor de JavaScript agradecería tu retroalimentación para saber como llamar a esa aberración que tiene las palabras: “Función anónima asíncrona” dentro de ella.\nCORS, un dolor de cabeza que no debería existir. (Literalmente) Si hicimos todo bien, luego de guardar nuestra página debería auto-refrescarse. Todo parece ir bien por ahora, pero si abrimos la consola podremos ver un error de JavaScript que nos dice:\nAccess to fetch at 'http://127.0.0.1:8000/api/cats' from origin 'http://localhost:8080' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled. El error viene de un bloqueo que nos hace CORS, ya que no existe un header especial que nos permita acceder a los recursos de la API como es debido. CORS es un acrónimo de Cross Origin Resource Sharing y es un mecanismo que permite que los sitios web pidan recursos a direcciones o dominios diferentes a donde están siendo servidos.\n¿Por qué existe? Pues por “protección”, lo pongo entre comillas por que en papel la idea es muy buena. La mayoría del tiempo nuestro sitio web y nuestra API están alojados en el mismo lugar. En nuestro caso este error está saltando porque rocket sirve nuestra API en 127.0.0.1:algo y svelte se encuentra en localhost:algo. Aunque puedan parecer lo mismo no lo son. Al usar 127.0.0.1 el software que utilizamos directamente lo convierte a una dirección IP y la usa. De otra forma hay que “resolver” un nombre a una dirección, suponiendo que estamos en linux nuestro archivo hosts nos puede ayudar, pero si algo cambia ahí dentro, entonces localhost puede ser algo totalmente diferente a 127.0.0.1.\nEn mi opinión personal esto es un poco extraño. No me hace sentido que, para que mi código pueda acceder a recursos externos necesite de headers especiales en las peticiones. Mucho menos en un entorno web donde el 99.9% de las páginas que visitamos son de hecho muchos recursos extraños, HTML, CSS y sobre todo JavaScript que es un lenguaje de programación completo que podría hacer cualquier cosa, como rastrearnos con analítica, acceder a nuestros sensores y otras cosas. Eso si, no sea un JSON de una URL externa porque arde Troya.\nEn pocas palabras, CORS es un cáncer, afortunadamente es un cáncer que tiene cura. Y la cura la podemos implementar en nuestro archivo main.rs, dentro del mismo tenemos que pegar el siguiente pedazo de código (arriba de la función rocket):\nstruct CORS; #[rocket::async_trait] impl Fairing for CORS { fn info(\u0026self) -\u003e Info { Info { name: \"Attaching CORS headers to responses\", kind: Kind::Response, } } async fn on_response\u003c'r\u003e(\u0026self, _request: \u0026'r Request\u003c'_\u003e, response: \u0026mut Response\u003c'r\u003e) { response.set_header(Header::new(\"Access-Control-Allow-Origin\", \"*\")); response.set_header(Header::new( \"Access-Control-Allow-Methods\", \"POST, GET, PATCH, OPTIONS\", )); response.set_header(Header::new(\"Access-Control-Allow-Headers\", \"*\")); response.set_header(Header::new(\"Access-Control-Allow-Credentials\", \"true\")); } } Ahora en la función rocket, debajo de .manage(pool) añadiremos la función .attach(CORS).\nEl archivo main.rs debería verse así ahora:\nuse dotenv::dotenv; use rocket::fairing::{Fairing, Info, Kind}; use rocket::http::Header; use rocket::{Request, Response}; use std::env; #[macro_use] extern crate diesel; #[macro_use] extern crate rocket; mod db; mod models; mod routes; mod schema; mod static_files; struct CORS; #[rocket::async_trait] impl Fairing for CORS { fn info(\u0026self) -\u003e Info { Info { name: \"Attaching CORS headers to responses\", kind: Kind::Response, } } async fn on_response\u003c'r\u003e(\u0026self, _request: \u0026'r Request\u003c'_\u003e, response: \u0026mut Response\u003c'r\u003e) { response.set_header(Header::new(\"Access-Control-Allow-Origin\", \"*\")); response.set_header(Header::new( \"Access-Control-Allow-Methods\", \"POST, GET, PATCH, OPTIONS\", )); response.set_header(Header::new(\"Access-Control-Allow-Headers\", \"*\")); response.set_header(Header::new(\"Access-Control-Allow-Credentials\", \"true\")); } } #[launch] fn rocket() -\u003e _ { dotenv().ok(); let db_url: String = env::var(\"DATABASE_URL\").expect(\"set DATABASE_URL\"); let pool = db::init_pool(db_url); rocket::build() .manage(pool) .attach(CORS) .mount( \"/api/\", routes![ crate::routes::index, crate::routes::new, crate::routes::show, crate::routes::delete, crate::routes::name, crate::routes::update ], ) .mount( \"/\", routes![crate::static_files::all, crate::static_files::index], ) } Recompilemos nuestro proyecto interrumpiendo la ejecución del API con Ctrl c y volvemos a compilar con $cargo run.\nSi refrescamos la página web donde se encuentra nuestro frontend podremos ver que el error relacionado con CORS desapareció.\nHagamos la estructura de los gatitos. Con el problema de CORS resuelto, podemos regresar a nuestro archivo App.svelte y dentro de las etiquetas main comenzaremos a crear la estructura HTML para mostrar los gatitos.\nEn mi caso, yo hice algo así para la estructura base:\n\u003ch1 align=\"center\"\u003eBase de Gatos 😺\u003c/h1\u003e \u003cdiv class=\"container\"\u003e \u003cdiv class=\"card\"\u003e \u003cimg class=\"img-gato\" src=\"\" alt=\"Foto del gatito\"/\u003e \u003ch2 class=\"cat-name\"\u003eNombre del gatito\u003c/h2\u003e \u003ch3 class=\"adopted\"\u003eAdoptado ❤️\u003c/h3\u003e \u003ch3 class=\"noadopted\"\u003eBuscando un hogar 🏠\u003c/h3\u003e \u003chr\u003e \u003cp class=\"cat-desc\"\u003eDescripción del gato\u003c/p\u003e \u003c/div\u003e \u003c/div\u003e Debería verse así en el navegador:\nHagamos que se vea lindo con el poder de CSS Como podrás ver, el HTML que hicimos ya tiene algunas clases que no existen, nuestro trabajo será hacerlas existir. Para ello debemos ir a las etiquetas style de nuestro archivo App.svelte y colocar el siguiente código:\n@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;700;900\u0026display=swap'); * { font-family: 'Poppins', sans-serif; } .container { align-content: center; display: grid; grid-template-columns: auto auto auto auto; grid-template-rows: auto auto auto auto; justify-content: space-evenly; } .card { border-radius: 1.5em; box-shadow: 1px 1px 2px 1px rgba(0, 0, 0, 0.3); margin: 1.3em; padding: 1.3em; } .img-gato { border-radius: 1.5em; display: inline-block; height: 45%; max-height: 100%; max-width: 100%; width: 45%; } .cat-name{ color: #452981; display: block; text-shadow: 1px 1px 1px #452981; } .adopted { background-color: #3a9104; background: linear-gradient(90deg, rgba(88,230,0,1) 0%, rgba(58,145,4,1) 100%); border-radius: 0.5em; box-shadow: 1px 1px 2px 1px rgba(58, 145, 4, 0.3); color: #FAFAFA; display: inline-block; font-size: 0.9em; padding: 5px; } .noadopted { background-color: #002e99; background: linear-gradient(90deg, rgba(0,77,255,1) 0%, rgba(0,46,153,1) 100%); border-radius: 0.5em; box-shadow: 1px 1px 2px 1px rgba(0, 46, 153, 0.3); color: #FAFAFA; display: inline-block; font-size: 0.9em; padding: 5px; } .cat-desc { color: #666666; margin-bottom: 1.5em; margin-top: 1.5em; overflow-wrap: break-word; padding-bottom: 5em; text-overflow: ellipsis; word-break: break-all; } Si hicimos todo correctamente nuestro sitio ahora debería verse así:\nYo agregué la foto del gato como ejemplo de internet. Por el momento las tarjetas se ven un poco feas. Ya que solo es una y como dije, no soy un desarrollador frontend, solo conozco un poco de CSS, lo suficiente para hacer cosas feas pero no horribles.\nImplementando las propiedades de Svelte. Ya tenemos la lógica de JavaScript, el maquetado con HTML y los estilos con CSS, ahora viene la integración de Svelte en la parte del frontend.\nPara consumir nuestra constante fetchCats haremos uso de la propiedad await que viene con Svelte. Await nos permitirá renderizar nuestro HTML dependiendo de los tres posibles estados de una Promise en JavaScript:\nPending Fullfilled Rejected Podemos saltar el tercer estado si podemos omitir renderizar un mensaje de error si el promise falla o si sabemos que nuestra promise jamás va a fallar. En todo caso lo incluiré. Esto debe hacerse en las etiquetas main de nuestro archivo App.svelte:\n\u003ch1 align=\"center\"\u003eBase de Gatos 😺\u003c/h1\u003e \u003cdiv class=\"container\"\u003e {#await fetchCats} \u003cp\u003eCargando gatos...\u003c/p\u003e {:then data} \u003cdiv class=\"card\"\u003e \u003cimg class=\"img-gato\" src=\"https://www.rover.com/blog/wp-content/uploads/2019/06/sitting-siamese-cat-960x540.jpg\" alt=\"Foto del gatito\"/\u003e \u003ch2 class=\"cat-name\"\u003eNombre del gatito\u003c/h2\u003e \u003ch3 class=\"adopted\"\u003eAdoptado ❤️\u003c/h3\u003e \u003ch3 class=\"noadopted\"\u003eBuscando un hogar 🏠\u003c/h3\u003e \u003chr\u003e \u003cp class=\"cat-desc\"\u003eDescripción del gato en cuestión. Las descripciones de los gatos largas son más convenientes para que las personas decidan adoptar a los gatitos que les presentemos.\u003c/p\u003e \u003c/div\u003e {:catch error} \u003cp\u003eOcurrió un error al cargar los gatos :(\u003c/p\u003e {/await} \u003c/div\u003e El párrafo () que está dentro del bloque {#await fetchCats} lo utilizaremos como “placeholder” en caso de que JS tarde en responder con nuestro JSON de gatos. Este podría ser el caso si tenemos miles de entradas o si nuestra conexión a internet es lenta.\nEl bloque {:then} será lo que renderizaremos si la promise de JavaScript llega al estado fullfilled, en este caso el bloque de HTML donde está nuestra tarjeta de gatitos.\nFinalmente el bloque {:catch error} y el párrafo () debajo cargarán solo y solo si la promise tuvo un error o fue rechazada (Gracias CORS).\nPerfecto, con esto tenemos la primera parte de nuestro renderizado de gatitos, ahora tenemos que cargar una tarjeta por gato en nuestra base de datos. Esto lo podemos hacer con la propiedad {#each} de Svelte, para recorrer el arreglo de gatitos que nos devuelve fetchCats.\nEn mi caso logré crear una tarjeta por gato así (esto es debajo del bloque {:then}):\n{#each data.result as cat} \u003cdiv class=\"card\"\u003e \u003cimg class=\"img-gato\" src=\"https://www.rover.com/blog/wp-content/uploads/2019/06/sitting-siamese-cat-960x540.jpg\" alt=\"Foto del gatito\"/\u003e \u003ch2 class=\"cat-name\"\u003eNombre del gatito\u003c/h2\u003e \u003ch3 class=\"adopted\"\u003eAdoptado ❤️\u003c/h3\u003e \u003ch3 class=\"noadopted\"\u003eBuscando un hogar 🏠\u003c/h3\u003e \u003chr\u003e \u003cp class=\"cat-desc\"\u003eDescripción del gato en cuestión. Las descripciones de los gatos largas son más convenientes para que las personas decidan adoptar a los gatitos que les presentemos.\u003c/p\u003e \u003c/div\u003e {/each} Perfecto, esto cargará una tarjeta por cada gato que tengamos registrado, en nuestro caso solo tenemos dos gatos por lo que el resultado se ve así:\nPero algo está mal…esos gatos no son los que registramos. Si eres un poco audaz, sabrás que le colocamos un nombre a cada valor de ese arreglo de gatos que estamos consultando, en este caso a cada elemento le llamamos cat, específicamente en la propiedad {#each data.result as cat}. Esto nos dejará acceder a las propiedades de cada elemento con el mismo nombre que les pusimos en nuestra API al inicio de este proyecto.\nVamos a sustituir los valores por defecto por cada uno de los valores correspondientes usando Svelte. También utilizaremos una propiedad {#if} para el caso de la adopción, sin embargo, considero que no debo explicar que hace esta propiedad por una razón sencilla, esto es un tutorial de como hacer un REST API, no un tutorial de programación básica.\nCon el código corregido, nuestro bloque de tarjetas debería verse así:\n\u003cdiv class=\"card\"\u003e \u003cimg class=\"img-gato\" src={cat.photo_url} alt=\"Foto del gatito\"/\u003e \u003ch2 class=\"cat-name\"\u003e{cat.name}\u003c/h2\u003e {#if cat.is_adopted} \u003ch3 class=\"adopted\"\u003eAdoptado ❤️\u003c/h3\u003e {:else} \u003ch3 class=\"noadopted\"\u003eBuscando un hogar 🏠\u003c/h3\u003e {/if} \u003chr\u003e \u003cp class=\"cat-desc\"\u003e{cat.description}\u003c/p\u003e \u003c/div\u003e ¡Perfecto! Ahora Svelte mostrará a los gatos correctos en el sitio:\nEn caso de que te hayas perdido, el archivo App.Svelte debería verse así una vez completes este paso:\n\u003cscript charset=\"utf-8\"\u003e // URL del API de los gatitos const api_url = 'http://127.0.0.1:8000/api/cats'; // Get api info const fetchCats = (async () =\u003e { const response = await fetch(api_url) return await response.json() })() \u003c/script\u003e \u003cstyle type=\"text/css\" media=\"screen\"\u003e @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;700;900\u0026display=swap'); * { font-family: 'Poppins', sans-serif; } .container { align-content: center; display: grid; grid-template-columns: auto auto auto auto; grid-template-rows: auto auto auto auto; justify-content: space-evenly; } .card { border-radius: 1.5em; box-shadow: 1px 1px 2px 1px rgba(0, 0, 0, 0.3); margin: 1.3em; padding: 1.3em; } .img-gato { border-radius: 1.5em; display: inline-block; height: 45%; max-height: 100%; max-width: 100%; width: 45%; } .cat-name{ color: #452981; display: block; text-shadow: 1px 1px 1px #452981; } .adopted { background-color: #3a9104; background: linear-gradient(90deg, rgba(88,230,0,1) 0%, rgba(58,145,4,1) 100%); border-radius: 0.5em; box-shadow: 1px 1px 2px 1px rgba(58, 145, 4, 0.3); color: #FAFAFA; display: inline-block; font-size: 0.9em; padding: 5px; } .noadopted { background-color: #002e99; background: linear-gradient(90deg, rgba(0,77,255,1) 0%, rgba(0,46,153,1) 100%); border-radius: 0.5em; box-shadow: 1px 1px 2px 1px rgba(0, 46, 153, 0.3); color: #FAFAFA; display: inline-block; font-size: 0.9em; padding: 5px; } .cat-desc { color: #666666; margin-bottom: 1.5em; margin-top: 1.5em; overflow-wrap: break-word; padding-bottom: 5em; text-overflow: ellipsis; word-break: break-all; } \u003c/style\u003e \u003cmain\u003e \u003ch1 align=\"center\"\u003eBase de Gatos 😺\u003c/h1\u003e \u003cdiv class=\"container\"\u003e {#await fetchCats} \u003cp\u003eCargando gatos...\u003c/p\u003e {:then data} {#each data.result as cat} \u003cdiv class=\"card\"\u003e \u003cimg class=\"img-gato\" src={cat.photo_url} alt=\"Foto del gatito\"/\u003e \u003ch2 class=\"cat-name\"\u003e{cat.name}\u003c/h2\u003e {#if cat.is_adopted} \u003ch3 class=\"adopted\"\u003eAdoptado ❤️\u003c/h3\u003e {:else} \u003ch3 class=\"noadopted\"\u003eBuscando un hogar 🏠\u003c/h3\u003e {/if} \u003chr\u003e \u003cp class=\"cat-desc\"\u003e{cat.description}\u003c/p\u003e \u003c/div\u003e {/each} {:catch error} \u003cp\u003eOcurrió un error al cargar los gatos :(\u003c/p\u003e {/await} \u003c/div\u003e \u003c/main\u003e ¡Y con esto podemos concluir el consumo de nuestra REST API con Svelte!\nCerrando el blog Sin dudas hacer una REST API no es un proceso que podamos catalogar como difícil, más bien es laborioso. Sin embargo sirve mucho para aprender como funcionan las API que consumimos a diario, aún de manera inconsciente cuando vamos a páginas web modernas. Ciertamente crear una en Rust desde cero no es la excepción en cuanto al tiempo se refiere, pero es entretenido y sobre todo didáctico.\nSi quieres usar este proyecto como plantilla para trabajos futuros eres bienvenid@ por mi. Puedes encontrar la plantilla del mismo aquí.\nEl código está bajo la licencia AGPL-3.0. Por lo que puede usarse para lo que sea :D\nSi te interesan los retos aquí tengo algunos para que juegues y aprendas un poco más de la REST API por ti mismo:\nIngresar muchos registros de gatos. Crear un endpoint para mostrar solo los gatos adoptados Crear un endpoint para mostrar solo los gatos que están buscando un hogar Implementar HTTPS en la API Implementar autenticación en la API Además, si quieres basarte en una API un poco más trabajada por mi parte tengo UpVentRS que es el proyecto que inspiró la creación de este blog.\nPor mucho es la entrada de blog más larga que he escrito en mucho tiempo (casi una hora de lectura) según Apostrophe. (Por cierto, tengo que cambiar de editor de Markdown, Apostrophe parecía buena idea al inicio, la cosa es que está hecho en slowthon y en entradas de blog como esta el live-preview e incluso la propia escritura se vuelven terriblemente acartonadas).\nSi te gustó mi contenido por favor compártelo con tus amigos, de ser posible suscríbete usando el botón de RSS en el fondo de la página o si te sientes con ánimos puedes invitarme un café picando el botón azúl en la esquina inferior izquierda de tu pantalla.\n¡Nos leemos pronto! :)\n¿Te gustan estos blogs? Ayúdame a seguir escribiéndolos de las siguientes formas:\nInvítame un café 🍵 Regálame un follow en GitHub ❤ ","wordCount":"11010","inLanguage":"en","image":"https://ventgrey.github.io/img/posts/api/cover.png","datePublished":"2022-01-24T00:00:00Z","dateModified":"2022-01-24T00:00:00Z","author":{"@type":"Person","name":"VentGrey"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ventgrey.github.io/posts/rest-api-rocket/"},"publisher":{"@type":"Organization","name":"La Esquina Gris","logo":{"@type":"ImageObject","url":"https://ventgrey.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ventgrey.github.io/ accesskey=h title="La Esquina Gris (Alt + H)"><img src=https://ventgrey.github.io/apple-touch-icon.png alt aria-label=logo height=35>La Esquina Gris</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ventgrey.github.io/categories/ title=Categorias><span>Categorias</span></a></li><li><a href=https://ventgrey.github.io/tags/ title=Etiquetas><span>Etiquetas</span></a></li><li><a href=https://upvent.codes title="¿Buscas a UpVent?"><span>¿Buscas a UpVent?</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ventgrey.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ventgrey.github.io/posts/>Posts</a></div><h1 class=post-title>Crear y consumir una REST API con Rust y Rocket</h1><div class=post-description>Todas las API son iguales. ¿Qué tan igual será una hecha en Rust y Rocket?</div><div class=post-meta><span title='2022-01-24 00:00:00 +0000 UTC'>January 24, 2022</span>&nbsp;·&nbsp;52 min&nbsp;·&nbsp;11010 words&nbsp;·&nbsp;VentGrey&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/rest-api-rocket.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#prerequisitos>Prerequisitos</a></li><li><a href=#preparando-el-entorno-de-trabajo>Preparando el entorno de trabajo</a><ul><li><a href=#el-magnánimo-orm>El magnánimo ORM</a></li><li><a href=#crear-un-proyecto-como-un-buen-dev-modernolleno-de-dependencias-externas>Crear un proyecto como un buen dev moderno&mldr;lleno de dependencias externas.</a></li></ul></li><li><a href=#creando-los-modelos-para-la-base-de-datos>Creando los modelos para la base de datos</a><ul><li><a href=#el-método-show>El método show</a></li><li><a href=#el-método-all>El método all</a></li><li><a href=#el-método-update-by-id>El método update by id</a></li><li><a href=#el-método-insert>El método insert</a></li><li><a href=#el-método-delete-by-id>El método delete by id</a></li><li><a href=#el-método-all-by-name>El método all by name</a></li></ul></li><li><a href=#probando-el-orm>Probando el ORM</a></li><li><a href=#añadiendo-rocket-con-soporte-para-json>Añadiendo rocket con soporte para JSON</a></li><li><a href=#implementando-r2d2>Implementando r2d2</a></li><li><a href=#rocket-y-las-rutas>Rocket y las rutas</a></li><li><a href=#manejando-archivos-estáticos>Manejando archivos estáticos</a></li><li><a href=#creando-los-endpoints>Creando los endpoints</a><ul><li><a href=#endpoint-index>Endpoint: index</a></li><li><a href=#endpoint-new>Endpoint: new</a></li><li><a href=#endpoint-show>Endpoint: show</a></li><li><a href=#endpoint-update>Endpoint: update</a></li><li><a href=#endpoint-delete>Endpoint: delete</a></li><li><a href=#endpoint-name>Endpoint: name</a></li></ul></li><li><a href=#montando-los-endpoints>Montando los endpoints</a></li><li><a href=#archivos-finales>Archivos finales</a><ul><li><a href=#srcmainrs>src/main.rs</a></li><li><a href=#srcmodelsrs>src/models.rs</a></li><li><a href=#srcroutesrs>src/routes.rs</a></li><li><a href=#srcstatic_filesrs>src/static_files.rs</a></li><li><a href=#srcschemars>src/schema.rs</a></li></ul></li><li><a href=#probando-nuestra-rest-api>Probando nuestra REST API</a></li><li><a href=#creando-un-frontend-para-nuestra-api>Creando un frontend para nuestra API</a></li><li><a href=#comenzando-con-svelte>Comenzando con Svelte</a></li><li><a href=#cors-un-dolor-de-cabeza-que-no-debería-existir-literalmente>CORS, un dolor de cabeza que no debería existir. (Literalmente)</a></li><li><a href=#hagamos-la-estructura-de-los-gatitos>Hagamos la estructura de los gatitos.</a></li><li><a href=#hagamos-que-se-vea-lindo-con-el-poder-de-css>Hagamos que se vea lindo con el poder de CSS</a></li><li><a href=#implementando-las-propiedades-de-svelte>Implementando las propiedades de Svelte.</a></li><li><a href=#cerrando-el-blog>Cerrando el blog</a></li></ul></nav></div></details></div><div class=post-content><h1 id=y-es-quetodas-las-api-son-iguales>Y es que&mldr;todas las API son iguales.<a hidden class=anchor aria-hidden=true href=#y-es-quetodas-las-api-son-iguales>#</a></h1><p>Seamos sinceros, todos hemos hecho al menos una REST API en nuestra vida, honestamente es algo de esperarse, siendo el estilo de arquitectura de software más popular de los últimos años. Si bien REST no es algo nuevo (Pues, su existencia puede rastrearse hasta el año 2000) sigue siendo un enfoque de desarrollo modular y en un todo muy conveniente. Sobre todo si hablamos de tecnologías basadas en la web.</p><p>No creo que sea necesario dar tanto contexto sobre qué es una REST API, mucho menos en estos años donde podemos encontrar (sin exagerar) miles de sitios donde se nos podría explicar perfectamente que son las REST API, como funcionan, sus casos de uso, ventajas, desventajas y todas esas cosas que nos encanta leer para excusar una flamewar en foros o grupos de chat.</p><p>Para esta entrada vamos a ver como crear y consumir una REST API. Con la parte de la creación utilizaremos <a href=https://www.rust-lang.org/>Rust</a> con <a href=https://rocket.rs/>Rocket</a> y para la parte del consumo una página web con un script básico debería funcionar. Asímismo voy a utilizar como ejemplo mi proyecto personal &ldquo;<a href=https://github.com/UpVent/upventrs>upventrs</a>&rdquo; (Por: UpVent RustSvelte). Donde pondré ejemplos de como podemos consumir nuestra REST API desde un framework para JavaScript como <a href=https://svelte.dev/>Svelte</a>.</p><h2 id=prerequisitos>Prerequisitos<a hidden class=anchor aria-hidden=true href=#prerequisitos>#</a></h2><p>Este es un trabajo o más bien un proyecto de medio nivel, por lo que se requiere tener un poco de experiencia con el lenguaje de programación Rust y, para la parte del &ldquo;Frontend&rdquo; es necesario conocer un poco de Svelte.</p><p>Claro, puedes seguir este tutorial sin cumplir estos prerequisitos, pero te será más complicado entender lo que de por si no puedo explicar a la perfección.</p><p>Si te interesa aprender un poco más aquí te dejo una lista de recursos que podrías encontrar interesantes:</p><ul><li><a href=https://github.com/rust-lang/rustlings>Ejercicios para dominar Rust</a></li><li><a href=https://svelte.dev/examples/hello-world>Compilación de ejemplos de Svelte</a></li><li><a href="https://www.youtube.com/watch?v=rv3Yq-B8qp4">Svelte en 100 segundos</a></li></ul><h2 id=preparando-el-entorno-de-trabajo>Preparando el entorno de trabajo<a hidden class=anchor aria-hidden=true href=#preparando-el-entorno-de-trabajo>#</a></h2><p>Si estás leyendo este tutorial asumiré que ya tienes un poco de experiencia con Rust (por lo menos la <a href=https://rustup.rs/>instalación</a> debería ser algo que ya lograste hacer con éxito). Para este trabajo vamos a crear un binario de Rust y añadiremos algunas dependencias.</p><h3 id=el-magnánimo-orm>El magnánimo ORM<a hidden class=anchor aria-hidden=true href=#el-magnánimo-orm>#</a></h3><p><img loading=lazy src=https://i.redd.it/1paoq27ri1h31.jpg alt="meme ORM"></p><p>Los ORM ya son el pan de cada día para los DBA (<em>Database Administrator</em>) y también para los desarrolladores <em>backend</em>. En este proyecto necesitaremos un ORM hecho en Rust que nos permita crear, modificar o re-ejecutar migraciones en nuestra base de datos. Para nuestra fortuna existe <a href=https://diesel.rs/>Diesel</a>, un ORM que ya está bastante maduro y que, además tiene otras ventajas que para un desarrollador de Rust solo podrían describirse como &ldquo;jugosas&rdquo;.</p><p>Diesel previene errores en tiempo de ejecución ya que, por diseño elimina la posiblidad de interactuar de forma incorrecta con la base de datos, si tu proyecto compila con Diesel no deberían existir errores que detengan su ejecución por una mala consulta. Además es terriblemente rápido y su código es <strong>MUY</strong> reutilizable en codebases grandes, lo cual, como desarrollador te ahorra mucho tiempo. La otra ventaja de Diesel es que no soporta una cantidad masiva de motores de bases de datos, por el momento Diesel solo tiene soporte para:</p><ul><li>MySQL / MariaDB</li><li>PostgreSQL</li><li>SQLite3</li></ul><p>Digo ventaja, porque la cantidad de motores de manejo de base de datos que hay hoy en día es enorme y las diferencias entre uno y otro son ridículas, algunas son razonables pero&mldr;siendo sinceros otras se hacen notar en entornos extraños (o enormes) de producción y en precios ridículos al momento de pagar. Diesel reduce esto diciendo de forma indirecta: &ldquo;Úsame con lo que está bien hecho o no me uses&rdquo;.</p><p>La parte de los motores de base de datos noSQL es otra historia, Diesel no está hecho para bases de datos no relacionales y este tipo de motores normalmente ya vienen con bibliotecas para varios lenguajes incluyendo Rust, MongoDB es el ejemplo más cercano que tengo de <a href=https://docs.mongodb.com/drivers/rust/>esto</a>.</p><p>Existe un problema con todo esto, necesitamos instalar la herramienta CLI (<em>command line interface</em>) de diesel, sin embargo, por la naturaleza del mismo necesitamos elegir las bibliotecas necesarias para poder compilar un binario acorde a nuestro sistema y a la base de datos que utilizaremos en nuestro proyecto.</p><p>Para mantener el concepto sencillo utilizaremos SQLite3 como base de datos para desarrollo. Si deseas utilizar otra cosa como PostgreSQL o MariaDB solo tendrás que sustituir algunas cosas. Parece confuso por ahora, pero una vez entiendas el código y el funcionamiento de Diesel te será sencillo migrar de una base de datos a otra.</p><h4 id=instalando-diesel-con-soporte-para-sqlite3>Instalando Diesel con soporte para SQLite3<a hidden class=anchor aria-hidden=true href=#instalando-diesel-con-soporte-para-sqlite3>#</a></h4><p>Diesel necesitará las bibliotecas de SQLite3 para poder compilarse correctamente en nuestra máquina, la biblioteca en cuestión se llama <code>libsqlite3</code> y existen diversas formas de instalarla en nuestros sistemas. No puedo hacer una lista entera de como instalar dicha biblioteca en todos los sistemas disponibles, en sistemas como Debian y Ubuntu puedes instalar esta biblioteca con la orden: <code>sudo apt install libsqlite3-dev</code>.</p><p>Una vez instalada la biblioteca de SQLite3 solo queda instalar Diesel usando Cargo en nuestra terminal: <code>cargo install diesel_cli --no-default-features --features sqlite</code></p><p>Los tiempos de compilación de Rust son lentos, sugiero que encuentres algo que hacer mientras el binario de Diesel se compila. Cuando Diesel termine de compilarse podemos continuar con el siguiente paso.</p><h3 id=crear-un-proyecto-como-un-buen-dev-modernolleno-de-dependencias-externas>Crear un proyecto como un buen dev moderno&mldr;lleno de dependencias externas.<a hidden class=anchor aria-hidden=true href=#crear-un-proyecto-como-un-buen-dev-modernolleno-de-dependencias-externas>#</a></h3><p><img loading=lazy src=https://tomatesasesinos.com/wp-content/uploads/2020/10/php_vs_nextjs.jpg alt=meme></p><p>Para crear un nuevo proyecto de Rust necesitamos usar la herramienta Cargo, de nuevo y como dije al inicio de esta entrada de blog, estoy asumiendo que ya tienes algo de experiencia con Rust. En caso de que hayas olvidado como crear un nuevo binario te recuerdo que la orden es: <code>cargo new --bin &lt;nombre></code>. En mi caso yo llamaré mi proyecto: <code>rest-rust-template</code> y encontrarás el enlace del repositorio al final de esta entrada. Eres libre de utilizar este repositorio como plantilla para futuros proyectos de REST API con Rust.</p><p>Dentro de nuestro proyecto de Rust debemos encontrar el archivo <code>Cargo.toml</code> y ahí añadir las dependencias necesarias. Antes de hacer esto debo hacer una recomendación y es que, cada que necesites utilizar una biblioteca hecha en Rust es recomendable que leas la documentación oficial en <a href=https://docs.rs/>https://docs.rs/</a>. La razón por la que digo esto es por que he visto una gran cantidad de tutoriales donde importan bibliotecas externas sin saber que a veces, la misma biblioteca que están utilizando tiene incrustadas las funciones de las bibliotecas externas por lo que solo estamos gastando espacio en disco y <em>namespace</em>.</p><p>En el caso de Diesel, necesitamos importarlo con dos <em>features</em> especiales, en este caso soporte para SQLite3 y r2d2 (un manejador de &ldquo;Pools&rdquo; para bases de datos. No te preocupes, explicaré esto a detalle más abajo).</p><p>El día en el que estoy escribiendo este blog, la versión de Diesel es la <code>1.4.4</code>, esto cambiará en el futuro. Asegúrate de seguir las instrucciones en el <a href=https://diesel.rs>sitio oficial de Diesel</a>.</p><p>Debemos añadir la siguiente línea a nuestro archivo <code>Cargo.toml</code> para instalar Diesel con las características mencionadas anteriormente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>diesel</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;1.4.4&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;sqlite&#34;</span><span class=p>,</span> <span class=s2>&#34;r2d2&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span></code></pre></div><p>Una vez hecho esto ejecutamos en nuestra consola (o IDE) el comando <code>$ cargo build</code> para constuir nuestro proyecto con Diesel y continuar trabajando correctamente.</p><p>Ahora viene la parte interesante y es colocar nuestra conexión a la base de datos en nuestro proyecto. Es bien sabido que, escribir la conexión en un string directamente en nuestro código es un error terrible, por lo que haremos uso de otra biblioteca llamada <code>dotenv</code>. Dotenv nos permite leer variables de entorno y guardarlas en nuestro programa para usarlas en un futuro, estas pueden leerse desde nuestro sistema o desde un archivo especial de nombre <code>.env</code>. Si has desarrollado un sistema anteriormente con otro lenguaje y framework como Python con Django o Flask ya tendrás algo de experiencia con este tipo de práctica.</p><p>De nuevo, ahora mismo que estoy escribiendo este blog la versión de dotenv es la <code>0.15.0</code> y, otra vez, esto puede cambiar en un futuro no muy lejano. Para añadir <code>dotenv</code> a nuestras dependencias debemos añadir la siguiente línea a nuestro archivo <code>Cargo.toml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>dotenv</span> <span class=p>=</span> <span class=s2>&#34;0.15.0&#34;</span>
</span></span></code></pre></div><p>La compilación de dotenv no debería tardar mucho.</p><p>La paciencia es virtud de sabios, pronto podremos comenzar a programar nuestra REST API, por el momento solo debemos escribir la URL de conexión a la base de datos en un archivo <code>.env</code> que Dotenv leerá desde nuestro código en Rust. Para manejadores de bases de datos más complejos la URL requiere de parámetros más específicos, sin embargo con SQLite3 esto no es necesario, solo debemos indicar el archivo donde guardaremos nuestros datos, todo esto puede lograrse de una forma sencilla con una sola orden en la línea de comandos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>DATABASE_URL</span><span class=o>=</span>debug.db &gt; .env
</span></span></code></pre></div><p>Hecho esto debemos ejecutar <code>$ diesel setup</code>. Si el archivo <code>debug.db</code> no existe no pasa nada, diesel lo creará por nosotros.</p><p>Antes de comenzar a programar debemos crear un archivo más además de nuestro archivo principal de Rust (<code>main.rs</code>), debemos crear un archivo llamado <code>models.rs</code> donde guardaremos los modelos de nuestra base de datos.</p><p>Creado nuestro archivo <code>models.rs</code> tenemos todo listo para comenzar a programar como todos unos campeones.</p><h2 id=creando-los-modelos-para-la-base-de-datos>Creando los modelos para la base de datos<a hidden class=anchor aria-hidden=true href=#creando-los-modelos-para-la-base-de-datos>#</a></h2><p>Para este ejemplo haremos una pequeña REST API para una tienda de mascotas, específicamente una tienda que vende gatos. Dentro de la misma guardaremos cuatro datos diferentes:</p><ul><li>Nombre del Gato</li><li>Foto del gato</li><li>¿Ya lo adoptaron?</li><li>Descripción del gato</li></ul><p>Para activar los lints y el uso correcto de los módulos en rust, debemos añadir la siguiente línea a nuestro archivo <code>main.rs</code>, recomiendo ponerla arriba de la función main, pero debajo de donde importamos las bibliotecas que usaremos en un futuro. Nuestro archivo <code>main.rs</code> deberá verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>models</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello, world!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Ahora regresemos a nuestro archivo <code>models.rs</code>, aquí debemos importar tres cosas de Diesel para comenzar a trabajar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>El primer import traerá al namespace las partes escenciales de Diesel, el segundo es el <code>prelude</code>, en escencia el prelude es una medida que se implemente para bibliotecas muy grandes que tienen una cantidad muy grande de funciones ampliamente usadas. Importar estas funciones una por una resultaría en un archivo muy grande o simplemente muy <em>verboso</em></p><p>Ahora debemos crear una estructura con visiblidad &ldquo;Pública&rdquo; donde guardaremos nuestros datos, en este caso la estructura se llamará <code>Cat</code> (gato, en inglés), entonces, dentro de nuestro archivo <code>models.rs</code> escribiremos la estructura correspondiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Los campos de <code>Cat</code> son los siguientes:</p><ul><li>id: El identificador numérico del gato en cuestión</li><li>name: El nombre del gato</li><li>photo_url: La dirección web donde podemos encontrar una foto de nuestro gato</li><li>is_adopted: Un booleano que nos indicará si ya adoptaron al gatito o no</li><li>description: La descripción del gato</li></ul><p>Para que Diesel reconozca esto como una tabla para la base de datos, debemos añadir un atributo a la estructura, en este caso el atributo es <code>#[derive(Queryable)]</code>. Al final nuestro archivo <code>models.rs</code> debería verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Queryable)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>No te preocupes por los warnings de imports sin usar, pronto comenzaremos a implementarlos.</p><p>¿Recuerdas cuando ejecutamos el comando <code>diesel setup</code>? Pues cuando entramos en el directorio de nuestro proyecto podremos ver una nueva carpeta llamada <code>migrations</code> pero, por el momento estará vacío. Para crear una nueva migración necesitaremos ejecutar el comando <code>diesel migration generate create_cats</code>. Puedes cambiar la parte de <code>create_cats</code> por el nombre que desees.</p><p>Si todo salió bien habrá un nuevo directorio con el formato <code>yyy-mm-dd-uuid_nombre</code>, en este caso el directorio de los gatitos se llama <code>2022-01-25-033422_create_cats</code>, dentro de este directorio se crearán dos archivos, un archivo <code>up.sql</code> y un archivo <code>down.sql</code>.</p><p>El archivo <code>up.sql</code> servirá para crear las tablas o hacer las operaciones necesarias en la migración. Antes de hacer nada, Diesel revisará este archivo y nos informará de errores de sintaxis o consultas que podrían ser potencialmente dañinas para la integridad de la base de datos.</p><p>Por otra parte el archivo <code>down.sql</code> se encargará de deshacer TODO lo que el archivo <code>up.sql</code> haga en la base de datos.</p><p>Personalmente esto es lo que me gusta de Diesel como ORM, al menos la parte de creación / eliminación de tablas se le deja completamente al usuario y, si bien uno podría argumentar que &ldquo;El ORM lo hace mejor&rdquo;, lo cierto es que, utilizando otro tipo de lenguaje, <em>te falta mucho barrio</em> si te equivocas creando o eliminado tablas, especialamente tablas sin dependencias o llaves foráneas.</p><p>Primero debemos modificar nuestro archivo <code>down.sql</code> y dentro de el colocaremos la siguiente línea:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>cats</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Si no sabes mucho de SQL es sencillo, si la tabla <code>cats</code> existe, si no existe, pues no hacemos nada.</p><p>Ahora vayamos al archivo <code>up.sql</code>, aquí es donde debemos escribir las consultas SQL para crear las tablas en la base de datos. En este caso tengo que recalcar una cosa importante, la sintaxis de las consultas puede variar de gestor a gestor, en este caso estamos usando la sintaxis de SQLite, por lo que esto podría <strong>NO</strong> funcionar en otros motores como MariaDB o PostgreSQL.</p><p>Dicho esto, la consulta SQL para crear la tabla necesaria es sencilla, por lo que nuestro archivo <code>up.sql</code> deberá verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>cats</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>photo_url</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>is_adopted</span><span class=w> </span><span class=nb>BOOLEAN</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>description</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>De nuevo, no hay que ser un genio en SQL para entender lo que hace esta consulta. Si la tabla <code>cats</code> no existe habrá que crearla primero, dentro de ella se creará un <code>id</code> que es un entero que fungirá como llave primaria, los otros campos utilizan las abstracciones de tipos de SQLite3, en este caso <code>TEXT</code> es similar a <code>VARCHAR</code> u otros tipos de dato similares en los manejadores SQL clásicos.</p><p>Cuando terminemos de escribir nuestros archivos <code>up.sql</code> y <code>down.sql</code> debemos ejecutar el comando <code>$ diesel migration run</code>. Esto ejecutará los archivos correspondientes para crear / eliminar las tablas de la base de datos. En caso de que algo salga mal, siempre podemos ejecutar el comando <code>$ diesel migration redo</code> para volver a ejecutar las migraciones &ldquo;desde cero&rdquo;.</p><p>En versiones anteriores de Diesel teníamos que ejecutar un comando para imprimir nuestro esquema de la base de datos, si mi memoria no me falla el comando era algo así: <code>diesel print-schema > src/schema.rs</code> . Sin embargo, ahora ese paso no es necesario, este comando se ejecutará de forma automática luego de las migraciones. Si realizamos los pasos correctamente el archivo <code>schema.rs</code> debería verse de la siguiente forma:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>table</span><span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cats</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>id</span><span class=w> </span>-&gt; <span class=nc>Integer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span>-&gt; <span class=nc>Text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>photo_url</span><span class=w> </span>-&gt; <span class=nc>Text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>is_adopted</span><span class=w> </span>-&gt; <span class=nc>Bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>description</span><span class=w> </span>-&gt; <span class=nc>Text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Si todo se generó correctamente, ahora podemos continuar editando nuestro archivo <code>models.rs</code> y añadir los siguientes imports debajo de diesel.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span>::<span class=n>dsl</span>::<span class=n>cats</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>all_cats</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Como dato importante, no debemos olvidar que debemos añadir <code>mod schema;</code> en nuestro archivo <code>main.rs</code> para incluirlo como módulo en nuestro proyecto de Rust.</p><p>Ahora viene una parte interesante. Para manejar las inserciones, modificaciones o eliminaciones de los registros en nuestra base de datos, necesitaremos de una segunda estructura con propiedades insertables y que apunte a un nombre de tabla en específico, solo hace falta copiar nuestra estructura anterior, eliminar el campo de identificación, añadir el prefijo <code>New</code> y un par de atributos por encima de la misma, estos atributos son <code>#[derive(Insertable)]</code> y <code>#[table_name = "cats"]</code>, en nuestro caso la estructura debería verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Insertable)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[table_name = </span><span class=s>&#34;cats&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Se lo que estás pensando: <em>&ldquo;Mi IDE me está diciendo que tengo errores por todos lados</em>&rdquo;, no te preocupes, esto pasa porque no le hemos indicado a Rust que deseamos utilizar los macros que vienen dentro de Diesel, esto se soluciona fácilmente añadiendo un par de líneas a nuestro archivo <code>main.rs</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// -- Bibliotecas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// -- Usar los macros de Diesel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// -- Módulos
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>mod</span> <span class=nn>models</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>schema</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello, world!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Esto debería eliminar los errores de compilación, quedarán un par de warnings, pero iremos eliminándolas poco a poco. Ahora, regresemos a nuestro archivo <code>models.rs</code> para crear los métodos comunes, para esto necesitamos crear una implementación <code>impl</code> para nuestra estructura <code>Cat</code>. Dentro de <code>models.rs</code> crearemos un nuevo bloque de implementación y en las siguientes secciones describiré los métodos que este bloque deberá contener. (No tienen que estar en el mismo orden.) De igual forma, si te pierdes en el proceso recuerda que al final del blog hay un enlace a un repositorio de GitHub donde podrás bajar el proyecto como plantilla, dentro de <code>models.rs</code> abre un nuevo bloque debajo de <code>NewCat</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=w> </span><span class=n>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// -- Métodos aquí
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>NOTA</strong>: Algunos métodos regresarán Vectores con datos y, más abajo será muy notorio por que, sin embargo, otros métodos regresarán solo un booleano para saber si la operación fue satisfactoria o no. Si aún no dominas las funciones y sus tipos de retorno en Rust te recomiendo volver a leer <a href=https://doc.rust-lang.org/book/>el libro</a>.</p><h3 id=el-método-show>El método show<a hidden class=anchor aria-hidden=true href=#el-método-show>#</a></h3><p>El método show nos permitirá mostrar una entrada de la base de datos en específico basados en el identificador, en pocas palabras nos mostrará los datos de el gato que nosotros necesitemos, siempre y cuando el gato exista y tenga un identificador válido.</p><p>Dentro de nuestro bloque <code>impl Cat{...}</code> podemos añadir el método <code>show</code> de la siguiente forma:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>show</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar el gato...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Considero que no es necesario explicar la estructura de la función en si, la parte interesante está en la forma de hacer consultas, <code>find()</code> busca por &ldquo;llave primaria&rdquo; según la <a href=https://docs.diesel.rs/1.4.x/diesel/dsl/type.Find.html>documentación de Diesel</a>, en este caso <code>id</code> lo definimos como una llave primaria en nuestra tabla SQL. Por otra parte <code>load</code> ejecuta una consulta y regresa un vector de resultados, al combinarlos tenemos la consulta completa donde primero buscamos al gato cuyo <code>id</code> sea igual al del parámetro de la función y luego ejecutamos la consulta, regresando un Vector de un solo elemento que en este caso es, el gato consultado.</p><p>No explicaré la parte del manejo de errores con <code>expect</code>, ya que es similar a <code>unwrap</code> pero con la habilidad de poner un mensaje de error personalizado, puedes leer más al respecto <a href=https://learning-rust.github.io/docs/e4.unwrap_and_expect.html>aquí</a>.</p><h3 id=el-método-all>El método all<a hidden class=anchor aria-hidden=true href=#el-método-all>#</a></h3><p>Este método nos arrojará un vector con todos los registros que tengamos en la base de datos de la estructura que le pedimos, en este caso <code>Cat</code>. El método es el siguiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>all</span><span class=p>(</span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>order</span><span class=p>(</span><span class=n>cats</span>::<span class=n>id</span><span class=p>.</span><span class=n>desc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar todos los gatos...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Por conveniencia, ordenaremos los gatos de forma descendente por identificador y luego ejecutaremos la consulta.</p><h3 id=el-método-update-by-id>El método update by id<a hidden class=anchor aria-hidden=true href=#el-método-update-by-id>#</a></h3><p>Este método nos permitirá actualizar la información de un solo gato siempre y cuando tengamos un identificador del mismo. Su estructura es un poco más compleja que las otras funciones porque requiere de consultar y reescribir todos y cada uno de los campos del gato en cuestión. El método es demasiado largo para explicarlo correctamente sin dar vueltas en múltiples temas, en muy resumidas cuentas, estamos creando una estructura con nuevo gato que reemplazará a al gato que Diesel encuentre en la línea <code>diesel::update(all_cats.find(id))</code>.</p><p>El método es el siguiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update_by_id</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>,</span><span class=w> </span><span class=n>cat</span>: <span class=nc>NewCat</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span>::<span class=n>dsl</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>description</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>d</span><span class=p>,</span><span class=w> </span><span class=n>is_adopted</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>photo_url</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>photo_url</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>is_adopted</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>description</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cat</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>update</span><span class=p>(</span><span class=n>all_cats</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>set</span><span class=p>((</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>n</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>name</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>p</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>photo_url</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>i</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>is_adopted</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>d</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>description</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=el-método-insert>El método insert<a hidden class=anchor aria-hidden=true href=#el-método-insert>#</a></h3><p>Insert, como su nombre lo dice nos permitirá insertar un nuevo gato en el registro de nuestra base de datos. El método no tiene mucha ciencia, solo debemos enviar una estructura <code>NewCat</code> al método (ya llena) y el se encargará de crear un nuevo registro en la base de datos con las medidas pertinentes. El método es el siguiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>insert</span><span class=p>(</span><span class=n>cat</span>: <span class=nc>NewCat</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>insert_into</span><span class=p>(</span><span class=n>cats</span>::<span class=n>table</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>values</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cat</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=el-método-delete-by-id>El método delete by id<a hidden class=anchor aria-hidden=true href=#el-método-delete-by-id>#</a></h3><p>Este método eliminará de la base de datos el gato con el id que solicitemos. Para evitar una operación incorrecta primero revisará si la tabla donde buscamos borrar el gato se encuentra vacía, si lo está simplemente regresará <code>false</code> pues no hay nada que borrar. El método es el siguiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>delete_by_id</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>show</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>conn</span><span class=p>).</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>delete</span><span class=p>(</span><span class=n>all_cats</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>)).</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>).</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=el-método-all-by-name>El método all by name<a hidden class=anchor aria-hidden=true href=#el-método-all-by-name>#</a></h3><p>El último método nos ayudará a listar múltiples gatos, en caso de que varios tengan el mismo nombre y necesitemos buscar uno en específico o en caso de que necesitemos trabajar con todos los gatos llamados &ldquo;Misifu&rdquo;. El método es el siguiente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>all_by_name</span><span class=p>(</span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>filter</span><span class=p>(</span><span class=n>cats</span>::<span class=n>name</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar los gatos por nombre&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Con esto podemos dar por terminados los métodos comunes y el &ldquo;esqueleto&rdquo; de nuestra REST API. Sin embargo esto aún no termina, aun necesitamos probarla, implementar rocket y sus endpoints para que los métodos nos regresen una respuesta en JSON y crear un pequeño frontend para consumir nuestra API de gatitos.</p><p>Nuestro archivo <code>models.rs</code> deberá verse así una vez terminemos de implementar estos métodos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span>::<span class=n>dsl</span>::<span class=n>cats</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>all_cats</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Queryable)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Insertable)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[table_name = </span><span class=s>&#34;cats&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>show</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar el gato...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>all</span><span class=p>(</span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>order</span><span class=p>(</span><span class=n>cats</span>::<span class=n>id</span><span class=p>.</span><span class=n>desc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar todos los gatos...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update_by_id</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>,</span><span class=w> </span><span class=n>cat</span>: <span class=nc>NewCat</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span>::<span class=n>dsl</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>description</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>d</span><span class=p>,</span><span class=w> </span><span class=n>is_adopted</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>photo_url</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>photo_url</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>is_adopted</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>description</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cat</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>update</span><span class=p>(</span><span class=n>all_cats</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>set</span><span class=p>((</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>n</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>name</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>p</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>photo_url</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>i</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>is_adopted</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>d</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>description</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>insert</span><span class=p>(</span><span class=n>cat</span>: <span class=nc>NewCat</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>insert_into</span><span class=p>(</span><span class=n>cats</span>::<span class=n>table</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>values</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cat</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>delete_by_id</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>show</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>conn</span><span class=p>).</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>delete</span><span class=p>(</span><span class=n>all_cats</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>)).</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>).</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>all_by_name</span><span class=p>(</span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>filter</span><span class=p>(</span><span class=n>cats</span>::<span class=n>name</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar los gatos por nombre&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=probando-el-orm>Probando el ORM<a hidden class=anchor aria-hidden=true href=#probando-el-orm>#</a></h2><p>Es tiempo de probar nuestro ORM y ver si es capaz de insertar datos correctamente en la base de datos, para ello necesitaremos hacer modificaciones menores a nuestro archivo <code>main.rs</code>, te mostraré como se deberá de ver, no te preocupes, que lo explicaré una vez mostrado el código:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>dotenv</span>::<span class=n>dotenv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>env</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>models</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>schema</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dotenv</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>database_url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;DATABASE_URL&#34;</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;No se encontró la variable DATABASE_URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SqliteConnection</span>::<span class=n>establish</span><span class=p>(</span><span class=o>&amp;</span><span class=n>database_url</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>models</span>::<span class=n>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span>: <span class=s>&#34;Erina&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>photo_url</span>: <span class=s>&#34;/img/posts/api/erina.jpg&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>is_adopted</span>: <span class=nc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>description</span>: <span class=s>&#34;Erina es un gato de la raza &#39;ocicat&#39; adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>models</span>::<span class=n>Cat</span>::<span class=n>insert</span><span class=p>(</span><span class=n>cat</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Se registró el gato correctamente&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;No se pudo añadir el gato a la base de datos&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Primero lo primero importamos las cosas necesarias. Dentro de la función <code>main</code> tenemos <code>dotenv().ok()</code>, de acuerdo a la <a href=https://docs.rs/dotenv/latest/dotenv/fn.dotenv.html>documentación de dotenv</a>, esto es todo lo que necesitamos para que la biblioteca lea el archivo <code>.env</code> que creamos antes y la cargue en memoria. Luego tenemos la variable <code>database_url</code> que utiliza <code>std::env</code> para leer una variable de entorno y guardarla como un <code>String</code> si es que la encuentra, en caso de no encontrarla el programa se detendrá y Rust nos enviará un error informándonos que dicha variable no se encontró.</p><p>La variable <code>conn</code> la utilizamos para crear una conexión a la base de datos Sqlite que creamos antes, esta se realiza utilizando la variable <code>database_url</code>, como regresa un <code>Result</code> podemos (aunque no es recomendado) utilizar el método <code>unwrap</code>, pues, si todo va bien no es necesario reportar nada, pero si falla, no tiene sentido continuar con la ejecución del programa, por lo tanto Rust hará que el programa falle directamente y termine su ejecución.</p><p>Debajo creamos una variable <code>cat</code> la cual solo es una estructura <code>NewCat</code> con los datos de un gato, en mi caso utilicé a mi gata Erina como prueba. Debajo de la declaración solo creamos una condicional para ver si la inserción en la base de datos fue realizada correctamente.</p><p>Si seguimos estos pasos al pie de la letra deberíamos poder ejecutar el comando <code>$ cargo run</code> y obtener la siguiente salida:</p><pre tabindex=0><code>warning: `rest-rust-template` (bin &#34;rest-rust-template&#34;) generated 5 warnings
    Finished dev [unoptimized + debuginfo] target(s) in 0.67s
     Running `target/debug/rest-rust-template`
Se registró el gato correctamente
</code></pre><p>Véase la última línea: <code>Se registró el gato correctamente</code>. Para comprobar esto utilizaré la herramienta <a href=https://sqlitebrowser.org/>sqlite browser</a> para revisar la base de datos y comprobar que en efecto, Erina fue registrada correctamente:</p><p><img loading=lazy src=/img/posts/api/sqlite.png alt="Imágen del explorador de Sqlite mostrando el registro de Erina"></p><p>¡Perfecto! Nuestros métodos de inserción funcionan. Ahora tomemos el camino riesgoso y comencemos a modificar nuestra API como bestias sin haber probado los otros métodos.</p><h2 id=añadiendo-rocket-con-soporte-para-json>Añadiendo rocket con soporte para JSON<a hidden class=anchor aria-hidden=true href=#añadiendo-rocket-con-soporte-para-json>#</a></h2><p>Si tienes buena memoria recordarás que, en nuestro archivo <code>Cargo.toml</code> ya colocamos <code>r2d2</code> como <em>&ldquo;feature&rdquo;</em> de Diesel en su momento, esto con la finalidad de evitar esa mala práctica de importar una nueva versión de una biblioteca cuando no es requerida forzosamente. Ahora haremos lo mismo con Rocket, normalmente se añade rocket, serde, serde-json y otras dependencias al archivo <code>Cargo.toml</code>, gracias al cielo con Rocket v0.5-rc1 esto ya no pasa, pues el soporte para JSON viene como <em>feature</em> y las crates de <code>rocket_codegen</code> y <code>rocket_contrib</code> ya se encuentran <em>deprecated</em>.</p><p>Solo es necesario añadir una línea con los features que deseamos incluir en nuestro proyecto, en este caso necesitamos de las features de JSON para que nuestra REST API pueda enviarnos los datos codificados como JSON a través de sus endpoints. Solo hay que añadir la línea <code>rocket = { version = "0.5.0-rc.1", features = [ "json" ] }</code> a nuestro archivo <code>Cargo.toml</code> y tenemos todo para ganar.</p><p>Hecho esto es recomendable volver a ejecutar <code>$cargo build</code> para que Cargo descargue y compile las dependencias necesarias para Rocket.</p><h2 id=implementando-r2d2>Implementando r2d2<a hidden class=anchor aria-hidden=true href=#implementando-r2d2>#</a></h2><p>Por el momento nuestra API funciona correctamente, sin embargo tiene un pequeño problema. Establecer una nueva conexión a una base de datos cada vez que necesitamos consumir datos de la misma es ineficiente y pesado en recursos, esto (por experiencia) puede hacer que la máquina que está ejecutando nuestro servidor comience a fallar, que salte el demonio <em>EarlyOOM</em> y mate procesos que considere innecesarios (a veces mata cosas importantes) o que simplemente el servidor colapse por falta de recursos.</p><p>Para solucionar este problema existe <code>r2d2</code> el cual podría definirse como un &ldquo;manejador de conexiones&rdquo; para las bases de datos.</p><p>La implementación es corta, no es sencilla y explicarla es complejo.</p><blockquote><p>Para serte sincero, ni yo tengo idea de que es lo que hice en ese momento, tuve que experimentar mucho con los genéricos, tutoriales y documentación sobre traits en Rust para llegar a un resultado que funcione bien.</p></blockquote><p>Primero debemos crear un archivo llamado <code>db.rs</code> en el mismo directorio donde se encuentra nuestro archivo <code>main.rs</code> (No olvides incluirlo como módulo dentro de <code>main.rs</code> usando <code>mod db;</code>), una vez incluido como módulo debemos añadir los siguientes imports al inicio del archivo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>r2d2</span>::<span class=n>ConnectionManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>http</span>::<span class=n>Status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>outcome</span>::<span class=n>try_outcome</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>outcome</span>::<span class=n>Outcome</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>request</span>::<span class=p>{</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>FromRequest</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=p>{</span><span class=n>Request</span><span class=p>,</span><span class=w> </span><span class=n>State</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=n>Deref</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Para ahorrarnos un par de errores en el futuro también es conveniente añadir estas líneas a nuestro archivo <code>main.rs</code> debajo del uso de macros de Diesel:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>rocket</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>En caso de que estés perdido en este punto, nuestro archivo <code>main.rs</code> deberá verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>dotenv</span>::<span class=n>dotenv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>env</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//-- Esto fue lo que añadimos
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>rocket</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//--
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>mod</span> <span class=nn>db</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>models</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>schema</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dotenv</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>database_url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;DATABASE_URL&#34;</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;No se encontró la variable DATABASE_URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SqliteConnection</span>::<span class=n>establish</span><span class=p>(</span><span class=o>&amp;</span><span class=n>database_url</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>models</span>::<span class=n>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span>: <span class=s>&#34;Erina&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>photo_url</span>: <span class=s>&#34;/img/posts/api/erina.jpg&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>is_adopted</span>: <span class=nc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>description</span>: <span class=s>&#34;Erina es un gato de la raza &#39;ocicat&#39; adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>models</span>::<span class=n>Cat</span>::<span class=n>insert</span><span class=p>(</span><span class=n>cat</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Se registró el gato correctamente&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;No se pudo añadir el gato a la base de datos&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Ahora si, de vuelta a nuestro archivo <code>db.rs</code>.</p><p>Dentro del mismo haremos un &ldquo;wrapper&rdquo; para un manejador de conexiones utilizando la versión de <code>r2d2</code> que viene con Diesel, una función de inicialización de manejo de conexiones y finalmente un par de traits para terminar la implementación.</p><p>Como dije anteriormente, este archivo es un poco complejo de explicar y este blog ya es de por si bastante largo, sin embargo no te dejaré con la curiosidad, aquí tienes algunos recursos que utilicé para esto:</p><ul><li><a href=https://api.rocket.rs/v0.5-rc/rocket/request/trait.FromRequest.html>El trait <code>FromRequest</code> de Rocket</a></li><li><a href=https://rocket.rs/v0.5-rc/guide/state/#within-guards>&ldquo;Guards&rdquo; con Rocket</a></li><li><a href=https://users.rust-lang.org/t/first-baby-steps-with-diesel-r2d2/37858/5>Primeros pasos con Rocket y r2d2</a></li><li><a href="https://docs.diesel.rs/diesel/r2d2/index.html?search=j#">La implementación de r2d2 de Diesel</a></li></ul><p>Con esta información servida, el archivo <code>db.rs</code> debería verse así:</p><p><strong>NOTA: Esto está diseñado para trabajar con bases de datos SQLite, con cosas como PostgreSQL y/o MySQL/MariaDB tus resultados podrían variar, así que deberás modificar esto de acuerdo a tus necesidades</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>r2d2</span>::<span class=n>ConnectionManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>http</span>::<span class=n>Status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>outcome</span>::<span class=n>try_outcome</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>outcome</span>::<span class=n>Outcome</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>request</span>::<span class=p>{</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>FromRequest</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=p>{</span><span class=n>Request</span><span class=p>,</span><span class=w> </span><span class=n>State</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=n>Deref</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Create a wrapper for the r2d2 Pool object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>type</span> <span class=nc>Pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>diesel</span>::<span class=n>r2d2</span>::<span class=n>Pool</span><span class=o>&lt;</span><span class=n>ConnectionManager</span><span class=o>&lt;</span><span class=n>SqliteConnection</span><span class=o>&gt;&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>init_pool</span><span class=p>(</span><span class=n>db_url</span>: <span class=nb>String</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Pool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ConnectionManager</span>::<span class=o>&lt;</span><span class=n>SqliteConnection</span><span class=o>&gt;</span>::<span class=n>new</span><span class=p>(</span><span class=n>db_url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>diesel</span>::<span class=n>r2d2</span>::<span class=n>Pool</span>::<span class=n>new</span><span class=p>(</span><span class=n>manager</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Failed to init database pool!&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Create a guard for our database connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Conn</span><span class=p>(</span><span class=k>pub</span><span class=w> </span><span class=n>diesel</span>::<span class=n>r2d2</span>::<span class=n>PooledConnection</span><span class=o>&lt;</span><span class=n>ConnectionManager</span><span class=o>&lt;</span><span class=n>SqliteConnection</span><span class=o>&gt;&gt;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[rocket::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;&#39;</span><span class=na>r</span><span class=o>&gt;</span><span class=w> </span><span class=n>FromRequest</span><span class=o>&lt;&#39;</span><span class=na>r</span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Conn</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>from_request</span><span class=p>(</span><span class=n>request</span>: <span class=kp>&amp;</span><span class=o>&#39;</span><span class=na>r</span> <span class=nc>Request</span><span class=o>&lt;&#39;</span><span class=nb>_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>request</span>::<span class=n>Outcome</span><span class=o>&lt;</span><span class=n>Conn</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>try_outcome</span><span class=o>!</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>guard</span>::<span class=o>&lt;&amp;</span><span class=n>State</span><span class=o>&lt;</span><span class=n>Pool</span><span class=o>&gt;&gt;</span><span class=p>().</span><span class=k>await</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Outcome</span>::<span class=n>Success</span><span class=p>(</span><span class=n>Conn</span><span class=p>(</span><span class=n>conn</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Outcome</span>::<span class=n>Failure</span><span class=p>((</span><span class=n>Status</span>::<span class=n>ServiceUnavailable</span><span class=p>,</span><span class=w> </span><span class=p>())),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Deref</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Conn</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Rust already inlines this, no need to specify the previous decorator.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>fn</span> <span class=nf>deref</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>Self</span>::<span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Antes de implementar nuestros métodos en <code>db.rs</code> tenemos que regresar a nuestro archivo <code>models.rs</code> para implementar Serde y así poder codificar nuestras estructuras en JSON.</p><p>Dentro de <code>models.rs</code> en la parte de los imports necesitamos añadir dos líneas extra, una para el serializador y otra para el deserializador:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>serde</span>::<span class=n>Deserialize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>serde</span>::<span class=n>Serialize</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Debajo, en la estructura <code>Cat</code> modificaremos el atributo <code>derive</code> para añadir los atributos <code>Serialize</code>, <code>Debug</code> y <code>Clone</code>.</p><p><strong>NOTA: Es probable que, si incluyes estos atributos, Cargo te arroje un error: <code>error[E0463]: can't find crate for serde</code>, esto ocurre por una regla de Rust llamada &ldquo;Rust Orphan Rule&rdquo;. El fix es sencillo, solo hace falta añadir un atributo extra debajo de derive</strong></p><p>De igual forma modificaremos la estructura <code>NewCat</code>, para no alargarme demasiado ambas estructuras deberán verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Serialize, Queryable, Debug, Clone)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[serde(crate = </span><span class=s>&#34;rocket::serde&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Insertable, Serialize, Deserialize)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[serde(crate = </span><span class=s>&#34;rocket::serde&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[table_name = </span><span class=s>&#34;cats&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Con esto la serialización y deserialización de nuestras estructuras en JSON está &ldquo;casi&rdquo; completa.</p><p>Es tiempo de implementar nuestro manejador de conexiones de bases de datos junto con rocket en nuestro archivo <code>main.rs</code></p><h2 id=rocket-y-las-rutas>Rocket y las rutas<a hidden class=anchor aria-hidden=true href=#rocket-y-las-rutas>#</a></h2><p>Para comenzar con Rocket es necesario modificar nuestra función <code>main</code>. Hay muchas formas de hacer esto según la documentación de Rocket, sin embargo yo recomiendo que eliminemos lo poco que tenemos en la función <code>main</code> y lo reemplazemos por esto:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[get(</span><span class=s>&#34;/&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>index</span><span class=p>()</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=o>&#39;</span><span class=nb>static</span> <span class=kt>str</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;Hello, world!&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[launch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>rocket</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>_</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rocket</span>::<span class=n>build</span><span class=p>().</span><span class=n>mount</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=n>index</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Solo debemos restaurar dos líneas para que el funcionamiento se acerque a lo que teníamos antes (no te preocupes por la prueba de inserción de datos, eso lo manejaremos más tarde), podemos aprovechar para utilizar nuestro manejador de conexiones de bases de datos en <code>db.rs</code> aquí:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[launch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>rocket</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>_</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dotenv</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db_url</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;DATABASE_URL&#34;</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;set DATABASE_URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// -- Se añadió esta linea
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span>::<span class=n>init_pool</span><span class=p>(</span><span class=n>db_url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// --
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>rocket</span>::<span class=n>build</span><span class=p>().</span><span class=n>mount</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=n>index</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=manejando-archivos-estáticos>Manejando archivos estáticos<a hidden class=anchor aria-hidden=true href=#manejando-archivos-estáticos>#</a></h2><p>Algo que nos sería de mucha utilidad sería una ruta para manejar los archivos estáticos y servirlos si son requeridos por el usuario. Para esto es necesario repetir el paso donde creamos un módulo. En el mismo directorio donde se encuentra <code>main.rs</code> debemos crear un archivo llamado <code>static_files.rs</code> y lo incluimos en <code>main.rs</code> con la línea <code>mod static_files;</code>.</p><p>Dentro de <code>static_files.rs</code> colocaremos el siguiente código:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>fs</span>::<span class=n>NamedFile</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>path</span>::<span class=p>{</span><span class=n>Path</span><span class=p>,</span><span class=w> </span><span class=n>PathBuf</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=n>NamedFile</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NamedFile</span>::<span class=n>open</span><span class=p>(</span><span class=s>&#34;public/index.html&#34;</span><span class=p>).</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/&lt;file..&gt;&#34;</span><span class=cp>, rank = 5)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>all</span><span class=p>(</span><span class=n>file</span>: <span class=nc>PathBuf</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=n>NamedFile</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NamedFile</span>::<span class=n>open</span><span class=p>(</span><span class=n>Path</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;public/&#34;</span><span class=p>).</span><span class=n>join</span><span class=p>(</span><span class=n>file</span><span class=p>)).</span><span class=k>await</span><span class=p>.</span><span class=n>ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>La primer función utiliza un macro declarativo y fungirá como el índice de nuestra página web servida con Rocket. Esta función <code>index</code> regresará un resultado con un archivo, el archivo en cuestión es un <code>index.html</code> dentro del directorio <code>public/</code>.</p><p>Asimismo en la función debajo hace algo similar, solo que utilizará los macros declarativos para servir archivos estáticos, en este caso todos los que se encuentren en el directorio <code>public/</code>.</p><p>Por el momento no crearemos ningún archivo estático. Recuerda que al inicio del tutorial dije que utilizaríamos Svelte como framework de JavaScript para ejemplificar como consumir esta pequeña API.</p><p>Ahora debemos añadir nuestras rutas estáticas a la función <code>rocket</code> en nuestro archivo <code>main.rs</code>, con las rutas añadidas la función <code>rocket</code> ahora debería verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[launch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>rocket</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>_</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dotenv</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db_url</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;DATABASE_URL&#34;</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;set DATABASE_URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span>::<span class=n>init_pool</span><span class=p>(</span><span class=n>db_url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rocket</span>::<span class=n>build</span><span class=p>().</span><span class=n>mount</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>all</span><span class=p>,</span><span class=w> </span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>index</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=creando-los-endpoints>Creando los endpoints<a hidden class=anchor aria-hidden=true href=#creando-los-endpoints>#</a></h2><p>Casi hemos terminado nuestra REST API, nos falta una parte muy importante que son los <em>endpoints</em>, estos devolverán una respuesta diferente dependiendo de la petición HTTP que les enviemos (GET, POST, UPDATE, DELETE, etc) o no enviarán nada. Para comenzar a desarrollar nuestros endpoints debemos crear un archivo <code>routes.rs</code> en el mismo directorio donde se encuentra nuestro archivo <code>main.rs</code> y añadirlo como módulo usando la línea <code>mod routes;</code>.</p><p>Dentro de nuestro archivo <code>routes.rs</code> debemos incluir los siguientes imports:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>db</span>::<span class=n>Conn</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>DbConn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>models</span>::<span class=p>{</span><span class=n>Cat</span><span class=p>,</span><span class=w> </span><span class=n>NewCat</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>serde</span>::<span class=n>json</span>::<span class=p>{</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Json</span><span class=p>,</span><span class=w> </span><span class=n>Value</span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><h3 id=endpoint-index>Endpoint: index<a hidden class=anchor aria-hidden=true href=#endpoint-index>#</a></h3><p>La primera cosa que implementaremos en nuestra API será un endpoint que nos permitirá sacar toda la información de nuestra base de datos en una sola operación. Rocket nos puede ayudar con el uso de atributos, en este caso atributos especiales para manejo de rutas y respuestas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[get(</span><span class=s>&#34;/cats&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cats</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cat</span>::<span class=n>all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=mi>200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>cats</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>La función hará una conexión a nuestra base de datos y regresará los datos ya formateados como JSON, dentro del JSON regresaremos dos cosas, el código de salida (200 en caso de que todo vaya bien) y <code>"result"</code> que será un arreglo enorme con todos los gatos que tengamos registrados en nuestra base de datos.</p><h3 id=endpoint-new>Endpoint: new<a hidden class=anchor aria-hidden=true href=#endpoint-new>#</a></h3><p>Ahora necesitamos crear un endpoint que nos permita crear un nuevo gato si es necesario:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[post(</span><span class=s>&#34;/cats&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>, data = </span><span class=s>&#34;&lt;new_cat&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>new_cat</span>: <span class=nc>Json</span><span class=o>&lt;</span><span class=n>NewCat</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>Cat</span>::<span class=n>insert</span><span class=p>(</span><span class=n>new_cat</span><span class=p>.</span><span class=n>into_inner</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>Cat</span>::<span class=n>all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>conn</span><span class=p>).</span><span class=n>first</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>El atributo que usaremos esta vez sirve para procesar peticiones POST, de igual forma la respuesta será en formato JSON, con la diferencia que ahora tendremos un campo nuevo llamado <code>data</code> el cual guardará un nuevo gato, en nuestro caso es el gato que guardaremos en la base de datos. Esta función nos devolverá un JSON con el estatus de salida de la inserción del gato y el resultado que es el mismo gato que acabamos de insertar en la base de datos.</p><h3 id=endpoint-show>Endpoint: show<a hidden class=anchor aria-hidden=true href=#endpoint-show>#</a></h3><p>Ahora ¿Qué pasa si necesitamos consultar un gato en específico? Simple, ahora necesitamos hacer un endpoint que nos permita hacer eso mismo, en esta caso lo llamaremos <code>show</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[get(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>show</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>result</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cat</span>::<span class=n>show</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>404</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>result</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Este endpoint vuelve a hacer uso del macro <code>GET</code>, solo que en este caso utiliza las directivas especiales de las rutas de Rocket, llamadas <em>Dynamic Paths</em> (mas información <a href=https://rocket.rs/v0.5-rc/guide/requests/#dynamic-paths>aquí</a>). Con esto podemos consultar el ID de un gato en específico y Rocket sabrá dirigirnos al mismo, lo mejor de todo es que nos devolverá el gato ya codificado como JSON.</p><h3 id=endpoint-update>Endpoint: update<a hidden class=anchor aria-hidden=true href=#endpoint-update>#</a></h3><p>¿Registraste mal un gato? ¿Alguien ya lo adoptó? Para eso podemos crear un endpoint <code>update</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[put(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>, data = </span><span class=s>&#34;&lt;cat&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>cat</span>: <span class=nc>Json</span><span class=o>&lt;</span><span class=n>NewCat</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>update_by_id</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=n>cat</span><span class=p>.</span><span class=n>into_inner</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>404</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Empiezo a pensar que todas las cosas que impliquen un update siempre serán un despelote&mldr;.<code>¯\_(ツ)_/¯</code> anyways.</p><p>Este método necesitará que le digamos en la URI el ID del gato que deseamos actualizar, para esto será necesario enviar un nuevo gato. La condicional en el JSON devuelto dependerá de la salida del comando de actualización. Si el gato pudo actualizarse correctamente el status de salida será un 200, en cualquier otro caso devolveremos un error 404 (Es recomendable manejar los errores mejor de lo que yo lo hice, pues una actualización no solo podría fallar por no encontrar un gato, si no por un error de servidor).</p><h3 id=endpoint-delete>Endpoint: delete<a hidden class=anchor aria-hidden=true href=#endpoint-delete>#</a></h3><p>Casi hemos terminado, ahora necesitamos un endpoint para eliminar un gato de la base de datos en caso de que lo necesitemos.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[delete(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>delete</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>delete_by_id</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>404</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Este endpoint hace uso del atributo <code>delete</code> y al igual que los anteriores, requiere del ID de un gato específico para que lo borre de nuestra base de datos. El modo de regresar el status es similar al del endpoint <code>update</code> y de nuevo lo recalcaré, recomiendo hacer un mejor manejo de errores.</p><h3 id=endpoint-name>Endpoint: name<a hidden class=anchor aria-hidden=true href=#endpoint-name>#</a></h3><p>Finalmente, en caso de que necesitemos consultar todos los gatos con un nombre en específico podemos crear un endpoint <code>name</code> para ello:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[get(</span><span class=s>&#34;/cats/names/&lt;name&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>name</span><span class=p>(</span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=mi>200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>Cat</span>::<span class=n>all_by_name</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Este endpoint llamará a la función <code>all_by_name</code> y nos devolverá un solo JSON con todos los gatos que compartan el mismo nombre. En este caso no manejé errores por flojo, no hagas eso tu también. Con este último endpoint nuestro archivo <code>routes.rs</code> debería estar terminado, en caso de que te hayas perdido el resultado final debería verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>db</span>::<span class=n>Conn</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>DbConn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>models</span>::<span class=p>{</span><span class=n>Cat</span><span class=p>,</span><span class=w> </span><span class=n>NewCat</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>serde</span>::<span class=n>json</span>::<span class=p>{</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Json</span><span class=p>,</span><span class=w> </span><span class=n>Value</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/cats&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cats</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cat</span>::<span class=n>all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=mi>200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>cats</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[post(</span><span class=s>&#34;/cats&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>, data = </span><span class=s>&#34;&lt;new_cat&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>new_cat</span>: <span class=nc>Json</span><span class=o>&lt;</span><span class=n>NewCat</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>Cat</span>::<span class=n>insert</span><span class=p>(</span><span class=n>new_cat</span><span class=p>.</span><span class=n>into_inner</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>Cat</span>::<span class=n>all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>conn</span><span class=p>).</span><span class=n>first</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>show</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>result</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cat</span>::<span class=n>show</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>404</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>result</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[put(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>, data = </span><span class=s>&#34;&lt;cat&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>cat</span>: <span class=nc>Json</span><span class=o>&lt;</span><span class=n>NewCat</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>update_by_id</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=n>cat</span><span class=p>.</span><span class=n>into_inner</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>404</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[delete(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>delete</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>delete_by_id</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>404</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/cats/names/&lt;name&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>name</span><span class=p>(</span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=mi>200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>Cat</span>::<span class=n>all_by_name</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=montando-los-endpoints>Montando los endpoints<a hidden class=anchor aria-hidden=true href=#montando-los-endpoints>#</a></h2><p>Casi hemos terminado nuestra REST API, solo queda montar los endpoints de nuestra API, para hacer esto solo tenemos que repetir el paso donde incluimos una función <code>mount()</code> en nuestro archivo <code>main.rs</code>, en este caso, montaremos nuestra API bajo la ruta <code>/api/</code> arriba de la ruta &ldquo;/&rdquo; . También podemos borrar el método <code>GET</code> que tenemos arriba de la función principal de Rocket:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[launch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>rocket</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>_</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dotenv</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db_url</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;DATABASE_URL&#34;</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;set DATABASE_URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span>::<span class=n>init_pool</span><span class=p>(</span><span class=n>db_url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rocket</span>::<span class=n>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>manage</span><span class=p>(</span><span class=n>pool</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>mount</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;/api/&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>index</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>new</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>show</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>delete</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>mount</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>all</span><span class=p>,</span><span class=w> </span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>index</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=archivos-finales>Archivos finales<a hidden class=anchor aria-hidden=true href=#archivos-finales>#</a></h2><p>Si te perdiste en el proceso y deseas saber como se ven los archivos en este punto, no te preocupes, debajo podrás leer en un subtítulo el nombre del archivo y como debería verse llegados a este punto.</p><h3 id=srcmainrs>src/main.rs<a hidden class=anchor aria-hidden=true href=#srcmainrs>#</a></h3><p>El archivo principal debería verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>dotenv</span>::<span class=n>dotenv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>env</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>rocket</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>db</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>models</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>routes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>schema</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>static_files</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[launch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>rocket</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>_</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dotenv</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db_url</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;DATABASE_URL&#34;</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;set DATABASE_URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span>::<span class=n>init_pool</span><span class=p>(</span><span class=n>db_url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rocket</span>::<span class=n>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>manage</span><span class=p>(</span><span class=n>pool</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>mount</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;/api/&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>index</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>new</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>show</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>delete</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>mount</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>all</span><span class=p>,</span><span class=w> </span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>index</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=srcmodelsrs>src/models.rs<a hidden class=anchor aria-hidden=true href=#srcmodelsrs>#</a></h3><p>El archivo de los modelos de la base de datos deberá verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>diesel</span>::<span class=n>sqlite</span>::<span class=n>SqliteConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>serde</span>::<span class=n>Deserialize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>serde</span>::<span class=n>Serialize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span>::<span class=n>dsl</span>::<span class=n>cats</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>all_cats</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Serialize, Queryable, Debug, Clone)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[serde(crate = </span><span class=s>&#34;rocket::serde&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Insertable, Serialize, Deserialize)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[serde(crate = </span><span class=s>&#34;rocket::serde&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[table_name = </span><span class=s>&#34;cats&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>photo_url</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_adopted</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Cat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>show</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar el gato...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>all</span><span class=p>(</span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>order</span><span class=p>(</span><span class=n>cats</span>::<span class=n>id</span><span class=p>.</span><span class=n>desc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar todos los gatos...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update_by_id</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>,</span><span class=w> </span><span class=n>cat</span>: <span class=nc>NewCat</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>schema</span>::<span class=n>cats</span>::<span class=n>dsl</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>description</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>d</span><span class=p>,</span><span class=w> </span><span class=n>is_adopted</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>photo_url</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>NewCat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>photo_url</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>is_adopted</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>description</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cat</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>update</span><span class=p>(</span><span class=n>all_cats</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>set</span><span class=p>((</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>n</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>name</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>p</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>photo_url</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>i</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>is_adopted</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>d</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>description</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>insert</span><span class=p>(</span><span class=n>cat</span>: <span class=nc>NewCat</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>insert_into</span><span class=p>(</span><span class=n>cats</span>::<span class=n>table</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>values</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cat</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>delete_by_id</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>show</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>conn</span><span class=p>).</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>diesel</span>::<span class=n>delete</span><span class=p>(</span><span class=n>all_cats</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>)).</span><span class=n>execute</span><span class=p>(</span><span class=n>conn</span><span class=p>).</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>all_by_name</span><span class=p>(</span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>all_cats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>filter</span><span class=p>(</span><span class=n>cats</span>::<span class=n>name</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Ocurrió un error al cargar los gatos por nombre&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=srcroutesrs>src/routes.rs<a hidden class=anchor aria-hidden=true href=#srcroutesrs>#</a></h3><p>El archivo de rutas (endpoints) de nuestra API deberá verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>db</span>::<span class=n>Conn</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>DbConn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>models</span>::<span class=p>{</span><span class=n>Cat</span><span class=p>,</span><span class=w> </span><span class=n>NewCat</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>serde</span>::<span class=n>json</span>::<span class=p>{</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Json</span><span class=p>,</span><span class=w> </span><span class=n>Value</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/cats&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cats</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cat</span>::<span class=n>all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=mi>200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>cats</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[post(</span><span class=s>&#34;/cats&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>, data = </span><span class=s>&#34;&lt;new_cat&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>new_cat</span>: <span class=nc>Json</span><span class=o>&lt;</span><span class=n>NewCat</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>Cat</span>::<span class=n>insert</span><span class=p>(</span><span class=n>new_cat</span><span class=p>.</span><span class=n>into_inner</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>Cat</span>::<span class=n>all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>conn</span><span class=p>).</span><span class=n>first</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>show</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>result</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cat</span>::<span class=n>show</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>404</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>result</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[put(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>, data = </span><span class=s>&#34;&lt;cat&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update</span><span class=p>(</span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>,</span><span class=w> </span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>cat</span>: <span class=nc>Json</span><span class=o>&lt;</span><span class=n>NewCat</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>update_by_id</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=n>cat</span><span class=p>.</span><span class=n>into_inner</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>404</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[delete(</span><span class=s>&#34;/cats/&lt;id&gt;&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>delete</span><span class=p>(</span><span class=n>id</span>: <span class=kt>i32</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>status</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>Cat</span>::<span class=n>delete_by_id</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>404</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=nc>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/cats/names/&lt;name&gt;&#34;</span><span class=cp>, format = </span><span class=s>&#34;application/json&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>name</span><span class=p>(</span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>conn</span>: <span class=nc>DbConn</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=n>json</span><span class=o>!</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;status&#34;</span>: <span class=mi>200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;result&#34;</span>: <span class=nc>Cat</span>::<span class=n>all_by_name</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=srcstatic_filesrs>src/static_files.rs<a hidden class=anchor aria-hidden=true href=#srcstatic_filesrs>#</a></h3><p>El archivo para manejar archivos estáticos en Rocket deberá verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>fs</span>::<span class=n>NamedFile</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>path</span>::<span class=p>{</span><span class=n>Path</span><span class=p>,</span><span class=w> </span><span class=n>PathBuf</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=n>NamedFile</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NamedFile</span>::<span class=n>open</span><span class=p>(</span><span class=s>&#34;public/index.html&#34;</span><span class=p>).</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/&lt;file..&gt;&#34;</span><span class=cp>, rank = 5)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>all</span><span class=p>(</span><span class=n>file</span>: <span class=nc>PathBuf</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=n>NamedFile</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NamedFile</span>::<span class=n>open</span><span class=p>(</span><span class=n>Path</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;public/&#34;</span><span class=p>).</span><span class=n>join</span><span class=p>(</span><span class=n>file</span><span class=p>)).</span><span class=k>await</span><span class=p>.</span><span class=n>ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=srcschemars>src/schema.rs<a hidden class=anchor aria-hidden=true href=#srcschemars>#</a></h3><p>El archivo autogenerado por Diesel deberá verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>table</span><span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cats</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>id</span><span class=w> </span>-&gt; <span class=nc>Integer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span>-&gt; <span class=nc>Text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>photo_url</span><span class=w> </span>-&gt; <span class=nc>Text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>is_adopted</span><span class=w> </span>-&gt; <span class=nc>Bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>description</span><span class=w> </span>-&gt; <span class=nc>Text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=probando-nuestra-rest-api>Probando nuestra REST API<a hidden class=anchor aria-hidden=true href=#probando-nuestra-rest-api>#</a></h2><p>Llegó el momento de la verdad, guardemos cambios y ejecutemos <code>$ cargo run</code> en nuestra terminal y observar la magia:</p><p><img loading=lazy src=/img/posts/api/rocket.png alt="imágen de rocket ejecutando una REST API"></p><p>Si ponemos atención a la sección que dice: <code>🛰 Routes:</code> podemos darnos cuenta de que todas nuestras rutas existen y parece que funcionan. Sin embargo no sabremos esto hasta hacer unas pruebas con la herramienta más poderosa que existe para probar REST API: <code>curl</code>.</p><p>En una nueva terminal intentemos ejecutar la siguiente orden:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -v http://127.0.0.1:8000/api/cats/
</span></span></code></pre></div><p>La salida de la terminal debería ser:</p><pre tabindex=0><code>*   Trying 127.0.0.1:8000...
* Connected to 127.0.0.1 (127.0.0.1) port 8000 (#0)
&gt; GET /api/cats/ HTTP/1.1
&gt; Host: 127.0.0.1:8000
&gt; User-Agent: curl/7.74.0
&gt; Accept: */*
&gt; 
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; content-type: application/json
&lt; server: Rocket
&lt; permissions-policy: interest-cohort=()
&lt; x-frame-options: SAMEORIGIN
&lt; x-content-type-options: nosniff
&lt; content-length: 567
&lt; date: Sun, 30 Jan 2022 05:29:32 GMT
&lt; 
* Connection #0 to host 127.0.0.1 left intact
{&#34;result&#34;:[{&#34;description&#34;:&#34;Erina es un gato de la raza &#39;ocicat&#39; adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.&#34;,&#34;id&#34;:2,&#34;is_adopted&#34;:true,&#34;name&#34;:&#34;Erina&#34;,&#34;photo_url&#34;:&#34;/img/posts/api/erina.jpg&#34;},{&#34;description&#34;:&#34;Erina es un gato de la raza &#39;ocicat&#39; adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.&#34;,&#34;id&#34;:1,&#34;is_adopted&#34;:true,&#34;name&#34;:&#34;Erina&#34;,&#34;photo_url&#34;:&#34;/img/posts/api/erina.jpg&#34;}],&#34;status&#34;:200}
</code></pre><p>Si miramos la pantalla de Rocket podremos ver que la salida muestra nuevas líneas:</p><pre tabindex=0><code>GET /api/cats/:
   &gt;&gt; Matched: (index) GET /api/cats application/json
   &gt;&gt; Outcome: Success
   &gt;&gt; Response succeeded.
</code></pre><p>¡Perfecto! Ahora probemos si podemos insertar un nuevo gato con la siguiente orden de curl:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -d <span class=s1>&#39;{ &#34;id&#34;:3, &#34;name&#34;:&#34;Erino&#34;, &#34;photo_url&#34;:&#34;/img/posts/api/erino.jpeg&#34;, &#34;is_adopted&#34;:true, &#34;description&#34;:&#34;Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado&#34; }&#39;</span> -H <span class=s1>&#39;Content-Type: application/json&#39;</span> http://127.0.0.1:8000/api/cats
</span></span></code></pre></div><p>La salida de la terminal debería ser la siguiente:</p><pre tabindex=0><code>{&#34;result&#34;:{&#34;description&#34;:&#34;Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado&#34;,&#34;id&#34;:3,&#34;is_adopted&#34;:true,&#34;name&#34;:&#34;Erino&#34;,&#34;photo_url&#34;:&#34;/img/posts/api/erino.jpeg&#34;},&#34;status&#34;:true}
</code></pre><p>Ahora comprobemos si nuestro gato nuevo fue registrado con éxito, con la primer orden que hicimos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -v http://127.0.0.1:8000/api/cats/                                                                         ~*   Trying 127.0.0.1:8000...* Connected to 127.0.0.1 <span class=o>(</span>127.0.0.1<span class=o>)</span> port <span class=m>8000</span> <span class=o>(</span><span class=c1>#0)</span>
</span></span><span class=line><span class=cl>&gt; GET /api/cats/ HTTP/1.1
</span></span><span class=line><span class=cl>&gt; Host: 127.0.0.1:8000
</span></span><span class=line><span class=cl>&gt; User-Agent: curl/7.74.0
</span></span><span class=line><span class=cl>&gt; Accept: */*
</span></span><span class=line><span class=cl>&gt; 
</span></span><span class=line><span class=cl>* Mark bundle as not supporting multiuse
</span></span><span class=line><span class=cl>&lt; HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>&lt; content-type: application/json
</span></span><span class=line><span class=cl>&lt; server: Rocket
</span></span><span class=line><span class=cl>&lt; permissions-policy: interest-cohort<span class=o>=()</span>
</span></span><span class=line><span class=cl>&lt; x-frame-options: SAMEORIGIN
</span></span><span class=line><span class=cl>&lt; x-content-type-options: nosniff
</span></span><span class=line><span class=cl>&lt; content-length: <span class=m>832</span>
</span></span><span class=line><span class=cl>&lt; date: Sun, <span class=m>30</span> Jan <span class=m>2022</span> 05:50:28 GMT
</span></span><span class=line><span class=cl>&lt; 
</span></span><span class=line><span class=cl>* Connection <span class=c1>#0 to host 127.0.0.1 left intact</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;result&#34;</span>:<span class=o>[{</span><span class=s2>&#34;description&#34;</span>:<span class=s2>&#34;Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado&#34;</span>,<span class=s2>&#34;id&#34;</span>:3,<span class=s2>&#34;is_adopted&#34;</span>:true,<span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;Erino&#34;</span>,<span class=s2>&#34;photo_url&#34;</span>:<span class=s2>&#34;/img/posts/api/erino.jpeg&#34;</span><span class=o>}</span>,<span class=o>{</span><span class=s2>&#34;description&#34;</span>:<span class=s2>&#34;Erina es un gato de la raza &#39;ocicat&#39; adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.&#34;</span>,<span class=s2>&#34;id&#34;</span>:2,<span class=s2>&#34;is_adopted&#34;</span>:true,<span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;Erina&#34;</span>,<span class=s2>&#34;photo_url&#34;</span>:<span class=s2>&#34;/img/posts/api/erina.jpg&#34;</span><span class=o>}</span>,<span class=o>{</span><span class=s2>&#34;description&#34;</span>:<span class=s2>&#34;Erina es un gato de la raza &#39;ocicat&#39; adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.&#34;</span>,<span class=s2>&#34;id&#34;</span>:1,<span class=s2>&#34;is_adopted&#34;</span>:true,<span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;Erina&#34;</span>,<span class=s2>&#34;photo_url&#34;</span>:<span class=s2>&#34;/img/posts/api/erina.jpg&#34;</span><span class=o>}]</span>,<span class=s2>&#34;status&#34;</span>:200<span class=o>}</span>
</span></span></code></pre></div><p>Espera&mldr;¿Hay dos &ldquo;Erina&rdquo; registadas? Eso es inadmisible, Erina solo hay una. Tendremos que borrar al impostor:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -X DELETE http://127.0.0.1:8000/api/cats/2
</span></span></code></pre></div><p>Comprobemos si la Erina impostora se eliminó correctamente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -v http://127.0.0.1:8000/api/cats/                                                                         ~*   Trying 127.0.0.1:8000...* Connected to 127.0.0.1 <span class=o>(</span>127.0.0.1<span class=o>)</span> port <span class=m>8000</span> <span class=o>(</span><span class=c1>#0)</span>
</span></span><span class=line><span class=cl>&gt; GET /api/cats/ HTTP/1.1
</span></span><span class=line><span class=cl>&gt; Host: 127.0.0.1:8000
</span></span><span class=line><span class=cl>&gt; User-Agent: curl/7.74.0
</span></span><span class=line><span class=cl>&gt; Accept: */*
</span></span><span class=line><span class=cl>&gt; 
</span></span><span class=line><span class=cl>* Mark bundle as not supporting multiuse
</span></span><span class=line><span class=cl>&lt; HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>&lt; content-type: application/json
</span></span><span class=line><span class=cl>&lt; server: Rocket
</span></span><span class=line><span class=cl>&lt; permissions-policy: interest-cohort<span class=o>=()</span>
</span></span><span class=line><span class=cl>&lt; x-frame-options: SAMEORIGIN
</span></span><span class=line><span class=cl>&lt; x-content-type-options: nosniff
</span></span><span class=line><span class=cl>&lt; content-length: <span class=m>561</span>
</span></span><span class=line><span class=cl>&lt; date: Sun, <span class=m>30</span> Jan <span class=m>2022</span> 05:54:35 GMT
</span></span><span class=line><span class=cl>&lt; 
</span></span><span class=line><span class=cl>* Connection <span class=c1>#0 to host 127.0.0.1 left intact</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;result&#34;</span>:<span class=o>[{</span><span class=s2>&#34;description&#34;</span>:<span class=s2>&#34;Erino es el hijo de Erina, es un gato de la misma raza, pequeño y travieso. Le gusta dormir estirado&#34;</span>,<span class=s2>&#34;id&#34;</span>:3,<span class=s2>&#34;is_adopted&#34;</span>:true,<span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;Erino&#34;</span>,<span class=s2>&#34;photo_url&#34;</span>:<span class=s2>&#34;/img/posts/api/erino.jpeg&#34;</span><span class=o>}</span>,<span class=o>{</span><span class=s2>&#34;description&#34;</span>:<span class=s2>&#34;Erina es un gato de la raza &#39;ocicat&#39; adoptada el 6 de Septiembre del 2021, es una gata tranquila y traviesa.&#34;</span>,<span class=s2>&#34;id&#34;</span>:1,<span class=s2>&#34;is_adopted&#34;</span>:true,<span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;Erina&#34;</span>,<span class=s2>&#34;photo_url&#34;</span>:<span class=s2>&#34;/img/posts/api/erina.jpg&#34;</span><span class=o>}]</span>,<span class=s2>&#34;status&#34;</span>:200<span class=o>}</span>
</span></span></code></pre></div><h2 id=creando-un-frontend-para-nuestra-api>Creando un frontend para nuestra API<a hidden class=anchor aria-hidden=true href=#creando-un-frontend-para-nuestra-api>#</a></h2><p>¡Perfecto! Ahora que nuestra API funciona, vamos a integrar un frontend para consumir los datos. En nuestro caso usaremos el framework Svelte. Para ello, podemos descomprimir el código proporcionado por Svelte. (Lo puedes descargar <a href=https://github.com/sveltejs/template>aquí</a>) Solo es necesario presionar el botón &ldquo;Code&rdquo; y luego presionar el botón &ldquo;Download Zip&rdquo;.</p><p>Podríamos usar la herramienta <code>degit</code> pero sinceramente, no le veo un uso práctico más alla ser un <code>git clone --depth=1</code> hecho en JS.</p><p>Colocamos el código descomprimido en el directorio donde tenemos el proyecto de Rust. Antes de ello, cambiaremos el nombre de la carpeta <code>src</code> de la plantilla de Svelte a algo como <code>frontend</code> para evitar conflictos con el directorio <code>src</code> de Rust.</p><p>Antes de continuar, debemos modificar el archivo <code>rollup.config.js</code> para indicarle que <code>frontend/</code> será nuestro nuevo directorio donde guardaremos el frontend de nuestra aplicación web. Si necesitas ayuda te dejo mi archivo <code>rollup.config.js</code> final para que lo tomes como guía:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>svelte</span> <span class=nx>from</span> <span class=s1>&#39;rollup-plugin-svelte&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>commonjs</span> <span class=nx>from</span> <span class=s1>&#39;@rollup/plugin-commonjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>resolve</span> <span class=nx>from</span> <span class=s1>&#39;@rollup/plugin-node-resolve&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>livereload</span> <span class=nx>from</span> <span class=s1>&#39;rollup-plugin-livereload&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>terser</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;rollup-plugin-terser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>css</span> <span class=nx>from</span> <span class=s1>&#39;rollup-plugin-css-only&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>production</span> <span class=o>=</span> <span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ROLLUP_WATCH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>serve</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>let</span> <span class=nx>server</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>function</span> <span class=nx>toExit</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>server</span><span class=p>)</span> <span class=nx>server</span><span class=p>.</span><span class=nx>kill</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>writeBundle</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>server</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=nx>server</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;child_process&#39;</span><span class=p>).</span><span class=nx>spawn</span><span class=p>(</span><span class=s1>&#39;npm&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;run&#39;</span><span class=p>,</span> <span class=s1>&#39;start&#39;</span><span class=p>,</span> <span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=s1>&#39;--dev&#39;</span><span class=p>],</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>stdio</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;ignore&#39;</span><span class=p>,</span> <span class=s1>&#39;inherit&#39;</span><span class=p>,</span> <span class=s1>&#39;inherit&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>shell</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>process</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;SIGTERM&#39;</span><span class=p>,</span> <span class=nx>toExit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nx>process</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;exit&#39;</span><span class=p>,</span> <span class=nx>toExit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>input</span><span class=o>:</span> <span class=s1>&#39;frontend/main.js&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>output</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sourcemap</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>format</span><span class=o>:</span> <span class=s1>&#39;iife&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;app&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>file</span><span class=o>:</span> <span class=s1>&#39;public/build/bundle.js&#39;</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=nx>plugins</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>		<span class=nx>svelte</span><span class=p>({</span>
</span></span><span class=line><span class=cl>			<span class=nx>compilerOptions</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// enable run-time checks when not in production
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>dev</span><span class=o>:</span> <span class=o>!</span><span class=nx>production</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}),</span>
</span></span><span class=line><span class=cl>		<span class=c1>// we&#39;ll extract any component CSS out into
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// a separate file - better for performance
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>css</span><span class=p>({</span> <span class=nx>output</span><span class=o>:</span> <span class=s1>&#39;bundle.css&#39;</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// If you have external dependencies installed from
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// npm, you&#39;ll most likely need these plugins. In
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// some cases you&#39;ll need additional configuration -
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// consult the documentation for details:
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// https://github.com/rollup/plugins/tree/master/packages/commonjs
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>resolve</span><span class=p>({</span>
</span></span><span class=line><span class=cl>			<span class=nx>browser</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>dedupe</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;svelte&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=p>}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>commonjs</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// In dev mode, call `npm run start` once
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// the bundle has been generated
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>!</span><span class=nx>production</span> <span class=o>&amp;&amp;</span> <span class=nx>serve</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Watch the `public` directory and refresh the
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// browser on changes when not in production
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>!</span><span class=nx>production</span> <span class=o>&amp;&amp;</span> <span class=nx>livereload</span><span class=p>(</span><span class=s1>&#39;public&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// If we&#39;re building for production (npm run build
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// instead of npm run dev), minify
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>production</span> <span class=o>&amp;&amp;</span> <span class=nx>terser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=nx>watch</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>clearScreen</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Perfecto. Ahora para terminar metemos todo el contenido de la plantilla de Svelte en nuestro proyecto de la REST API de Rust:</p><pre tabindex=0><code>tree -L 1                                                                          rest-rust-template -&gt; master ?
.
├── Cargo.lock
├── Cargo.toml
├── debug.db
├── diesel.toml
├── frontend
├── migrations
├── package.json
├── public
├── README.md
├── rollup.config.js
├── scripts
├── src
└── target

6 directories, 7 files
</code></pre><p>Si tu estructura de directorios es similar, entonces todo perfecto. Solo falta un último paso antes de comenzar con el frontend, hay que añadir las siguientes líneas al archivo <code>.gitignore</code>:</p><pre tabindex=0><code>/node_modules/
/public/build/
.DS_Store
</code></pre><p>Perfecto, con eso evitaremos subir cosas que no necesitamos al repositorio de git.</p><h2 id=comenzando-con-svelte>Comenzando con Svelte<a hidden class=anchor aria-hidden=true href=#comenzando-con-svelte>#</a></h2><p><strong>Nota: Recuerda encender el servidor de Rocket con <code>$cargo run</code> para acceder a los recursos de la API</strong></p><p>Dentro de nuestro directorio del proyecto ejecutaremos la orden <code>$ npm install && npm run dev</code> para comenzar con la instalación de dependencias y la vista en vivo de nuestro proyecto con NodeJS.</p><p>Cuando la terminal lo indique, se nos entregará una URL para revisar el progreso de nuestra aplicación de Svelte, en mi caso la URL es: <code>http://localhost:8080</code>. Si entramos a esta URL en nuestro navegador preferido obtendremos una pantalla así:</p><p><img loading=lazy src=/img/posts/api/svelte.png alt="pantalla de proyecto de SvelteJS"></p><p>Tengo que decir que yo no soy un desarrollador frontend (ni deseo serlo realmente) por lo que la interfaz que voy a construir es por mucho, muy fea.</p><p>Dentro de nuestro proyecto de Svelte entraremos a editar el archivo <code>App.svelte</code>. Aquí ocurrirá toda la magia.</p><p>Dentro de <code>App.svelte</code> podemos ver que ya hay contenido, sugiero borrar todo lo que hay dentro y colocar esto en su lugar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/css&#34;</span> <span class=na>media</span><span class=o>=</span><span class=s>&#34;screen&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Con esto tendremos un marco de trabajo para comenzar con el proyecto. Antes de comenzar a programar nada debo decir que el enfoque de SvelteJS es hacer interfaces con un framework sencillo pero completo y sobre todo enfocado en hacer componentes.</p><p>En este caso no estoy creando componentes por simplicidad, sin embargo en proyectos más serios desapruebo encarecidamente hacer todo dentro de <code>App.svelte</code>.</p><p>Con esta advertencia hecha, ahora si. Vamos a programar la parte de JavaScript que nos entregará a nuestros gatos registrados, dentro de las etiquetas <code>script</code> colocaremos el siguiente código:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// URL del API de los gatitos
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>api_url</span> <span class=o>=</span> <span class=s1>&#39;http://127.0.0.1:8000/api/cats&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Obtener información del API
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>fetchCats</span> <span class=o>=</span> <span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=nx>api_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kr>await</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>})()</span>
</span></span></code></pre></div><p>Este pequeño trozo de código lo que hará es definir la URL donde nuestro servidor de Rocket está ejecutándose. Lo segundo es una constante que es (con mi conocimiento límitado del desmadre de lenguaje que es JavaScript) el resultado del uso del <a href=https://developer.mozilla.org/es/docs/Web/API/Fetch_API/Using_Fetch>API fetch</a> de JavaScript. Honestamente no sabría explicar esas líneas de código a detalle, si eres un conocedor de JavaScript agradecería tu retroalimentación para saber como llamar a esa aberración que tiene las palabras: &ldquo;Función anónima asíncrona&rdquo; dentro de ella.</p><h2 id=cors-un-dolor-de-cabeza-que-no-debería-existir-literalmente>CORS, un dolor de cabeza que no debería existir. (Literalmente)<a hidden class=anchor aria-hidden=true href=#cors-un-dolor-de-cabeza-que-no-debería-existir-literalmente>#</a></h2><p>Si hicimos todo bien, luego de guardar nuestra página debería auto-refrescarse. Todo parece ir bien por ahora, pero si abrimos la consola podremos ver un error de JavaScript que nos dice:</p><pre tabindex=0><code>Access to fetch at &#39;http://127.0.0.1:8000/api/cats&#39; from origin &#39;http://localhost:8080&#39; has been blocked by CORS policy: No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource. If an opaque response serves your needs, set the request&#39;s mode to &#39;no-cors&#39; to fetch the resource with CORS disabled.
</code></pre><p><img loading=lazy src=http://images2.memedroid.com/images/UPLOADED83/533dbb4331fcc.jpeg alt="meme reese malcom el de en medio"></p><p>El error viene de un bloqueo que nos hace CORS, ya que no existe un header especial que nos permita acceder a los recursos de la API como es debido. CORS es un acrónimo de <em>Cross Origin Resource Sharing</em> y es un mecanismo que permite que los sitios web pidan recursos a direcciones o dominios diferentes a donde están siendo servidos.</p><p>¿Por qué existe? Pues por &ldquo;protección&rdquo;, lo pongo entre comillas por que en papel la idea es muy buena. La mayoría del tiempo nuestro sitio web y nuestra API están alojados en el mismo lugar. En nuestro caso este error está saltando porque rocket sirve nuestra API en <code>127.0.0.1:algo</code> y svelte se encuentra en <code>localhost:algo</code>. Aunque puedan parecer lo mismo no lo son. Al usar <code>127.0.0.1</code> el software que utilizamos directamente lo convierte a una dirección IP y la usa. De otra forma hay que &ldquo;resolver&rdquo; un nombre a una dirección, suponiendo que estamos en linux nuestro archivo <code>hosts</code> nos puede ayudar, pero si algo cambia ahí dentro, entonces <code>localhost</code> puede ser algo totalmente diferente a <code>127.0.0.1</code>.</p><p>En mi opinión personal esto es un poco extraño. No me hace sentido que, para que mi código pueda acceder a recursos externos necesite de headers especiales en las peticiones. Mucho menos en un entorno web donde el 99.9% de las páginas que visitamos son de hecho muchos recursos extraños, HTML, CSS y sobre todo JavaScript que es un lenguaje de programación completo que podría hacer cualquier cosa, como rastrearnos con analítica, acceder a nuestros sensores y otras cosas. Eso si, no sea un JSON de una URL externa porque arde Troya.</p><p>En pocas palabras, CORS es un cáncer, afortunadamente es un cáncer que tiene cura. Y la cura la podemos implementar en nuestro archivo <code>main.rs</code>, dentro del mismo tenemos que pegar el siguiente pedazo de código (arriba de la función <code>rocket</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>CORS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[rocket::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Fairing</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>CORS</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>info</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Info</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Info</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>name</span>: <span class=s>&#34;Attaching CORS headers to responses&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>kind</span>: <span class=nc>Kind</span>::<span class=n>Response</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>on_response</span><span class=o>&lt;&#39;</span><span class=na>r</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>_request</span>: <span class=kp>&amp;</span><span class=o>&#39;</span><span class=na>r</span> <span class=nc>Request</span><span class=o>&lt;&#39;</span><span class=nb>_</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>response</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Response</span><span class=o>&lt;&#39;</span><span class=na>r</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Origin&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;*&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;Access-Control-Allow-Methods&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;POST, GET, PATCH, OPTIONS&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Headers&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;*&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Credentials&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Ahora en la función <code>rocket</code>, debajo de <code>.manage(pool)</code> añadiremos la función <code>.attach(CORS)</code>.</p><p>El archivo <code>main.rs</code> debería verse así ahora:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>dotenv</span>::<span class=n>dotenv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>fairing</span>::<span class=p>{</span><span class=n>Fairing</span><span class=p>,</span><span class=w> </span><span class=n>Info</span><span class=p>,</span><span class=w> </span><span class=n>Kind</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=n>http</span>::<span class=n>Header</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rocket</span>::<span class=p>{</span><span class=n>Request</span><span class=p>,</span><span class=w> </span><span class=n>Response</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>env</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>diesel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>rocket</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>db</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>models</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>routes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>schema</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>static_files</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>CORS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[rocket::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Fairing</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>CORS</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>info</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Info</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Info</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>name</span>: <span class=s>&#34;Attaching CORS headers to responses&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>kind</span>: <span class=nc>Kind</span>::<span class=n>Response</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>on_response</span><span class=o>&lt;&#39;</span><span class=na>r</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>_request</span>: <span class=kp>&amp;</span><span class=o>&#39;</span><span class=na>r</span> <span class=nc>Request</span><span class=o>&lt;&#39;</span><span class=nb>_</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>response</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Response</span><span class=o>&lt;&#39;</span><span class=na>r</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Origin&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;*&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;Access-Control-Allow-Methods&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;POST, GET, PATCH, OPTIONS&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Headers&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;*&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=n>Header</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Credentials&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[launch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>rocket</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>_</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dotenv</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db_url</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;DATABASE_URL&#34;</span><span class=p>).</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;set DATABASE_URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span>::<span class=n>init_pool</span><span class=p>(</span><span class=n>db_url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rocket</span>::<span class=n>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>manage</span><span class=p>(</span><span class=n>pool</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>attach</span><span class=p>(</span><span class=n>CORS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>mount</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;/api/&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>index</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>new</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>show</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>delete</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>crate</span>::<span class=n>routes</span>::<span class=n>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>mount</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>routes</span><span class=o>!</span><span class=p>[</span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>all</span><span class=p>,</span><span class=w> </span><span class=k>crate</span>::<span class=n>static_files</span>::<span class=n>index</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Recompilemos nuestro proyecto interrumpiendo la ejecución del API con Ctrl c y volvemos a compilar con <code>$cargo run</code>.</p><p>Si refrescamos la página web donde se encuentra nuestro frontend podremos ver que el error relacionado con CORS desapareció.</p><h2 id=hagamos-la-estructura-de-los-gatitos>Hagamos la estructura de los gatitos.<a hidden class=anchor aria-hidden=true href=#hagamos-la-estructura-de-los-gatitos>#</a></h2><p>Con el problema de CORS resuelto, podemos regresar a nuestro archivo <code>App.svelte</code> y dentro de las etiquetas <code>main</code> comenzaremos a crear la estructura HTML para mostrar los gatitos.</p><p>En mi caso, yo hice algo así para la estructura base:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span> <span class=na>align</span><span class=o>=</span><span class=s>&#34;center&#34;</span><span class=p>&gt;</span>Base de Gatos 😺<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;container&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>img</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;img-gato&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Foto del gatito&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h2</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-name&#34;</span><span class=p>&gt;</span>Nombre del gatito<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;adopted&#34;</span><span class=p>&gt;</span>Adoptado ❤️<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;noadopted&#34;</span><span class=p>&gt;</span>Buscando un hogar 🏠<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>hr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-desc&#34;</span><span class=p>&gt;</span>Descripción del gato<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Debería verse así en el navegador:</p><p><img loading=lazy src=/img/posts/api/basedegatos1.png alt="foto del HTML básico de los gatitos"></p><h2 id=hagamos-que-se-vea-lindo-con-el-poder-de-css>Hagamos que se vea lindo con el poder de CSS<a hidden class=anchor aria-hidden=true href=#hagamos-que-se-vea-lindo-con-el-poder-de-css>#</a></h2><p>Como podrás ver, el HTML que hicimos ya tiene algunas clases que no existen, nuestro trabajo será hacerlas existir. Para ello debemos ir a las etiquetas <code>style</code> de nuestro archivo <code>App.svelte</code> y colocar el siguiente código:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl>    <span class=p>@</span><span class=k>import</span> <span class=nt>url</span><span class=o>(</span><span class=s1>&#39;https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;700;900&amp;display=swap&#39;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>*</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>font-family</span><span class=p>:</span> <span class=s1>&#39;Poppins&#39;</span><span class=p>,</span> <span class=kc>sans-serif</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>container</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>align-content</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=k>grid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>grid-template-columns</span><span class=p>:</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>grid-template-rows</span><span class=p>:</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>justify-content</span><span class=p>:</span> <span class=kc>space</span><span class=o>-</span><span class=n>evenly</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>card</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>2</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>margin</span><span class=p>:</span> <span class=mf>1.3</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding</span><span class=p>:</span> <span class=mf>1.3</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>img-gato</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>inline-block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>height</span><span class=p>:</span> <span class=mi>45</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>max-height</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>max-width</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>width</span><span class=p>:</span> <span class=mi>45</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>cat-name</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#452981</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>text-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mh>#452981</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>adopted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>background-color</span><span class=p>:</span> <span class=mh>#3a9104</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>background</span><span class=p>:</span> <span class=nb>linear-gradient</span><span class=p>(</span><span class=mi>90</span><span class=kt>deg</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>88</span><span class=p>,</span><span class=mi>230</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>0</span><span class=kt>%</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>58</span><span class=p>,</span><span class=mi>145</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>100</span><span class=kt>%</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>0.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>2</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>58</span><span class=p>,</span> <span class=mi>145</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#FAFAFA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>inline-block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>font-size</span><span class=p>:</span> <span class=mf>0.9</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding</span><span class=p>:</span> <span class=mi>5</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>noadopted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>background-color</span><span class=p>:</span> <span class=mh>#002e99</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>background</span><span class=p>:</span> <span class=nb>linear-gradient</span><span class=p>(</span><span class=mi>90</span><span class=kt>deg</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>77</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>0</span><span class=kt>%</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>153</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>100</span><span class=kt>%</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>0.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>2</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>46</span><span class=p>,</span> <span class=mi>153</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#FAFAFA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>inline-block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>font-size</span><span class=p>:</span> <span class=mf>0.9</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding</span><span class=p>:</span> <span class=mi>5</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>cat-desc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#666666</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>margin-bottom</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>margin-top</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>overflow-wrap</span><span class=p>:</span> <span class=kc>break-word</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding-bottom</span><span class=p>:</span> <span class=mi>5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>text-overflow</span><span class=p>:</span> <span class=kc>ellipsis</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>word-break</span><span class=p>:</span> <span class=n>break-all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>Si hicimos todo correctamente nuestro sitio ahora debería verse así:</p><p><img loading=lazy src=/img/posts/api/basedegatos2.png alt="foto del sitio con las reglas CSS aplicadas"></p><p>Yo agregué la foto del gato como ejemplo de internet. Por el momento las tarjetas se ven un poco feas. Ya que solo es una y como dije, no soy un desarrollador frontend, solo conozco un poco de CSS, lo suficiente para hacer cosas feas pero no horribles.</p><h2 id=implementando-las-propiedades-de-svelte>Implementando las propiedades de Svelte.<a hidden class=anchor aria-hidden=true href=#implementando-las-propiedades-de-svelte>#</a></h2><p>Ya tenemos la lógica de JavaScript, el maquetado con HTML y los estilos con CSS, ahora viene la integración de Svelte en la parte del frontend.</p><p>Para consumir nuestra constante <code>fetchCats</code> haremos uso de la propiedad <code>await</code> que viene con Svelte. Await nos permitirá renderizar nuestro HTML dependiendo de los tres posibles estados de una <em>Promise</em> en JavaScript:</p><ul><li>Pending</li><li>Fullfilled</li><li>Rejected</li></ul><p>Podemos saltar el tercer estado si podemos omitir renderizar un mensaje de error si el promise falla o si sabemos que nuestra promise jamás va a fallar. En todo caso lo incluiré. Esto debe hacerse en las etiquetas <code>main</code> de nuestro archivo <code>App.svelte</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span> <span class=na>align</span><span class=o>=</span><span class=s>&#34;center&#34;</span><span class=p>&gt;</span>Base de Gatos 😺<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;container&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        {#await fetchCats}
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Cargando gatos...<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        {:then data}
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>img</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;img-gato&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://www.rover.com/blog/wp-content/uploads/2019/06/sitting-siamese-cat-960x540.jpg&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Foto del gatito&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h2</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-name&#34;</span><span class=p>&gt;</span>Nombre del gatito<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;adopted&#34;</span><span class=p>&gt;</span>Adoptado ❤️<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;noadopted&#34;</span><span class=p>&gt;</span>Buscando un hogar 🏠<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>hr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-desc&#34;</span><span class=p>&gt;</span>Descripción del gato en cuestión. Las descripciones de los gatos largas son más convenientes para que las personas decidan adoptar a los gatitos que les presentemos.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        {:catch error}
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Ocurrió un error al cargar los gatos :(<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        {/await}
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>El párrafo (<code>&lt;p></code>) que está dentro del bloque <code>{#await fetchCats}</code> lo utilizaremos como &ldquo;placeholder&rdquo; en caso de que JS tarde en responder con nuestro JSON de gatos. Este podría ser el caso si tenemos miles de entradas o si nuestra conexión a internet es lenta.</p><p>El bloque <code>{:then}</code> será lo que renderizaremos si la <em>promise</em> de JavaScript llega al estado <em>fullfilled</em>, en este caso el bloque de HTML donde está nuestra tarjeta de gatitos.</p><p>Finalmente el bloque <code>{:catch error}</code> y el párrafo (<code>&lt;p></code>) debajo cargarán solo y solo si la <em>promise</em> tuvo un error o fue rechazada (Gracias CORS).</p><p>Perfecto, con esto tenemos la primera parte de nuestro renderizado de gatitos, ahora tenemos que cargar una tarjeta por gato en nuestra base de datos. Esto lo podemos hacer con la propiedad <code>{#each}</code> de Svelte, para recorrer el arreglo de gatitos que nos devuelve <code>fetchCats</code>.</p><p>En mi caso logré crear una tarjeta por gato así (esto es debajo del bloque <code>{:then}</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>            {#each data.result as cat}
</span></span><span class=line><span class=cl>                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>img</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;img-gato&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://www.rover.com/blog/wp-content/uploads/2019/06/sitting-siamese-cat-960x540.jpg&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Foto del gatito&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>h2</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-name&#34;</span><span class=p>&gt;</span>Nombre del gatito<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;adopted&#34;</span><span class=p>&gt;</span>Adoptado ❤️<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;noadopted&#34;</span><span class=p>&gt;</span>Buscando un hogar 🏠<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>hr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-desc&#34;</span><span class=p>&gt;</span>Descripción del gato en cuestión. Las descripciones de los gatos largas son más convenientes para que las personas decidan adoptar a los gatitos que les presentemos.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            {/each}
</span></span></code></pre></div><p>Perfecto, esto cargará una tarjeta por cada gato que tengamos registrado, en nuestro caso solo tenemos dos gatos por lo que el resultado se ve así:</p><p><img loading=lazy src=/img/posts/api/basedegatos3.png alt="dos tarjetas mostrando dos gatos en nuestro frontend"></p><p>Pero algo está mal&mldr;esos gatos no son los que registramos. Si eres un poco audaz, sabrás que le colocamos un nombre a cada valor de ese arreglo de gatos que estamos consultando, en este caso a cada elemento le llamamos <code>cat</code>, específicamente en la propiedad <code>{#each data.result as cat}</code>. Esto nos dejará acceder a las propiedades de cada elemento con el mismo nombre que les pusimos en nuestra API al inicio de este proyecto.</p><p>Vamos a sustituir los valores por defecto por cada uno de los valores correspondientes usando Svelte. También utilizaremos una propiedad <code>{#if}</code> para el caso de la adopción, sin embargo, considero que no debo explicar que hace esta propiedad por una razón sencilla, esto es un tutorial de como hacer un REST API, no un tutorial de programación básica.</p><p>Con el código corregido, nuestro bloque de tarjetas debería verse así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>img</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;img-gato&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>{cat.photo_url}</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Foto del gatito&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>h2</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-name&#34;</span><span class=p>&gt;</span>{cat.name}<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    {#if cat.is_adopted}
</span></span><span class=line><span class=cl>                        <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;adopted&#34;</span><span class=p>&gt;</span>Adoptado ❤️<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    {:else}
</span></span><span class=line><span class=cl>                        <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;noadopted&#34;</span><span class=p>&gt;</span>Buscando un hogar 🏠<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    {/if}
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>hr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-desc&#34;</span><span class=p>&gt;</span>{cat.description}<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>¡Perfecto! Ahora Svelte mostrará a los gatos correctos en el sitio:</p><p><img loading=lazy src=/img/posts/api/basedegatos4.png alt="Imágen mostrando a los gatos en Svelte"></p><p>En caso de que te hayas perdido, el archivo <code>App.Svelte</code> debería verse así una vez completes este paso:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// URL del API de los gatitos
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>api_url</span> <span class=o>=</span> <span class=s1>&#39;http://127.0.0.1:8000/api/cats&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Get api info
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>fetchCats</span> <span class=o>=</span> <span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=nx>api_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kr>await</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>})()</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/css&#34;</span> <span class=na>media</span><span class=o>=</span><span class=s>&#34;screen&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>@</span><span class=k>import</span> <span class=nt>url</span><span class=o>(</span><span class=s1>&#39;https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;700;900&amp;display=swap&#39;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>*</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>font-family</span><span class=p>:</span> <span class=s1>&#39;Poppins&#39;</span><span class=p>,</span> <span class=kc>sans-serif</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>container</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>align-content</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=k>grid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>grid-template-columns</span><span class=p>:</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>grid-template-rows</span><span class=p>:</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span> <span class=kc>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>justify-content</span><span class=p>:</span> <span class=kc>space</span><span class=o>-</span><span class=n>evenly</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>card</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>2</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>margin</span><span class=p>:</span> <span class=mf>1.3</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding</span><span class=p>:</span> <span class=mf>1.3</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>img-gato</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>inline-block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>height</span><span class=p>:</span> <span class=mi>45</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>max-height</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>max-width</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>width</span><span class=p>:</span> <span class=mi>45</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>cat-name</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#452981</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>text-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mh>#452981</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>adopted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>background-color</span><span class=p>:</span> <span class=mh>#3a9104</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>background</span><span class=p>:</span> <span class=nb>linear-gradient</span><span class=p>(</span><span class=mi>90</span><span class=kt>deg</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>88</span><span class=p>,</span><span class=mi>230</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>0</span><span class=kt>%</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>58</span><span class=p>,</span><span class=mi>145</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>100</span><span class=kt>%</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>0.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>2</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>58</span><span class=p>,</span> <span class=mi>145</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#FAFAFA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>inline-block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>font-size</span><span class=p>:</span> <span class=mf>0.9</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding</span><span class=p>:</span> <span class=mi>5</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>noadopted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>background-color</span><span class=p>:</span> <span class=mh>#002e99</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>background</span><span class=p>:</span> <span class=nb>linear-gradient</span><span class=p>(</span><span class=mi>90</span><span class=kt>deg</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>77</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>0</span><span class=kt>%</span><span class=p>,</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>153</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=mi>100</span><span class=kt>%</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>border-radius</span><span class=p>:</span> <span class=mf>0.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=mi>2</span><span class=kt>px</span> <span class=mi>1</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>46</span><span class=p>,</span> <span class=mi>153</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#FAFAFA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>display</span><span class=p>:</span> <span class=kc>inline-block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>font-size</span><span class=p>:</span> <span class=mf>0.9</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding</span><span class=p>:</span> <span class=mi>5</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nc>cat-desc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=mh>#666666</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>margin-bottom</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>margin-top</span><span class=p>:</span> <span class=mf>1.5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>overflow-wrap</span><span class=p>:</span> <span class=kc>break-word</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>padding-bottom</span><span class=p>:</span> <span class=mi>5</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>text-overflow</span><span class=p>:</span> <span class=kc>ellipsis</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>word-break</span><span class=p>:</span> <span class=n>break-all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span> <span class=na>align</span><span class=o>=</span><span class=s>&#34;center&#34;</span><span class=p>&gt;</span>Base de Gatos 😺<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;container&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        {#await fetchCats}
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Cargando gatos...<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        {:then data}
</span></span><span class=line><span class=cl>            {#each data.result as cat}
</span></span><span class=line><span class=cl>                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>img</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;img-gato&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>{cat.photo_url}</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Foto del gatito&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>h2</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-name&#34;</span><span class=p>&gt;</span>{cat.name}<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    {#if cat.is_adopted}
</span></span><span class=line><span class=cl>                        <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;adopted&#34;</span><span class=p>&gt;</span>Adoptado ❤️<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    {:else}
</span></span><span class=line><span class=cl>                        <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;noadopted&#34;</span><span class=p>&gt;</span>Buscando un hogar 🏠<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    {/if}
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>hr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;cat-desc&#34;</span><span class=p>&gt;</span>{cat.description}<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            {/each}
</span></span><span class=line><span class=cl>        {:catch error}
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Ocurrió un error al cargar los gatos :(<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        {/await}
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>¡Y con esto podemos concluir el consumo de nuestra REST API con Svelte!</p><h2 id=cerrando-el-blog>Cerrando el blog<a hidden class=anchor aria-hidden=true href=#cerrando-el-blog>#</a></h2><p>Sin dudas hacer una REST API no es un proceso que podamos catalogar como difícil, más bien es laborioso. Sin embargo sirve mucho para aprender como funcionan las API que consumimos a diario, aún de manera inconsciente cuando vamos a páginas web modernas. Ciertamente crear una en Rust desde cero no es la excepción en cuanto al tiempo se refiere, pero es entretenido y sobre todo didáctico.</p><p>Si quieres usar este proyecto como plantilla para trabajos futuros eres bienvenid@ por mi. Puedes encontrar la plantilla del mismo <a href=https://github.com/VentGrey/rest-rust-api-template>aquí</a>.</p><p>El código está bajo la licencia <a href=https://github.com/VentGrey/rest-rust-api-template/blob/master/LICENSE>AGPL-3.0</a>. Por lo que puede usarse para lo que sea :D</p><p>Si te interesan los retos aquí tengo algunos para que juegues y aprendas un poco más de la REST API por ti mismo:</p><ul><li>Ingresar muchos registros de gatos.</li><li>Crear un endpoint para mostrar solo los gatos adoptados</li><li>Crear un endpoint para mostrar solo los gatos que están buscando un hogar</li><li>Implementar HTTPS en la API</li><li>Implementar autenticación en la API</li></ul><p>Además, si quieres basarte en una API un poco más trabajada por mi parte tengo <a href=https://github.com/UpVent/upventrs>UpVentRS</a> que es el proyecto que inspiró la creación de este blog.</p><p>Por mucho es la entrada de blog más larga que he escrito en mucho tiempo (casi una hora de lectura) según <a href=https://apps.gnome.org/es/app/org.gnome.gitlab.somas.Apostrophe/>Apostrophe</a>. (Por cierto, tengo que cambiar de editor de Markdown, Apostrophe parecía buena idea al inicio, la cosa es que está hecho en slowthon y en entradas de blog como esta el live-preview e incluso la propia escritura se vuelven terriblemente acartonadas).</p><p>Si te gustó mi contenido por favor compártelo con tus amigos, de ser posible suscríbete usando el botón de RSS en el fondo de la página o si te sientes con ánimos puedes invitarme un café picando el botón azúl en la esquina inferior izquierda de tu pantalla.</p><p>¡Nos leemos pronto! :)</p><hr><p>¿Te gustan estos blogs? Ayúdame a seguir escribiéndolos de las siguientes formas:</p><ul><li><a href=https://ko-fi.com/ventgrey>Invítame un café 🍵</a></li><li><a href=https://github.com/VentGrey>Regálame un follow en GitHub ❤</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ventgrey.github.io/tags/rust/>Rust</a></li><li><a href=https://ventgrey.github.io/tags/rocket/>Rocket</a></li><li><a href=https://ventgrey.github.io/tags/api/>API</a></li><li><a href=https://ventgrey.github.io/tags/svelte/>Svelte</a></li><li><a href=https://ventgrey.github.io/tags/base-de-datos/>Base de datos</a></li></ul><nav class=paginav><a class=prev href=https://ventgrey.github.io/posts/fuentes-personalizadas-svelte/><span class=title>« Prev</span><br><span>Como añadir fuentes personalizadas a un proyecto de Svelte (Sin plugins de Vite)</span></a>
<a class=next href=https://ventgrey.github.io/posts/configurar-lemonbar-en-linux/><span class=title>Next »</span><br><span>Configurar lemonbar en linux</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Crear y consumir una REST API con Rust y Rocket on twitter" href="https://twitter.com/intent/tweet/?text=Crear%20y%20consumir%20una%20REST%20API%20con%20Rust%20y%20Rocket&url=https%3a%2f%2fventgrey.github.io%2fposts%2frest-api-rocket%2f&hashtags=Rust%2cRocket%2cAPI%2cSvelte%2cBasededatos"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Crear y consumir una REST API con Rust y Rocket on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fventgrey.github.io%2fposts%2frest-api-rocket%2f&title=Crear%20y%20consumir%20una%20REST%20API%20con%20Rust%20y%20Rocket&summary=Crear%20y%20consumir%20una%20REST%20API%20con%20Rust%20y%20Rocket&source=https%3a%2f%2fventgrey.github.io%2fposts%2frest-api-rocket%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Crear y consumir una REST API con Rust y Rocket on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fventgrey.github.io%2fposts%2frest-api-rocket%2f&title=Crear%20y%20consumir%20una%20REST%20API%20con%20Rust%20y%20Rocket"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Crear y consumir una REST API con Rust y Rocket on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fventgrey.github.io%2fposts%2frest-api-rocket%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Crear y consumir una REST API con Rust y Rocket on whatsapp" href="https://api.whatsapp.com/send?text=Crear%20y%20consumir%20una%20REST%20API%20con%20Rust%20y%20Rocket%20-%20https%3a%2f%2fventgrey.github.io%2fposts%2frest-api-rocket%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Crear y consumir una REST API con Rust y Rocket on telegram" href="https://telegram.me/share/url?text=Crear%20y%20consumir%20una%20REST%20API%20con%20Rust%20y%20Rocket&url=https%3a%2f%2fventgrey.github.io%2fposts%2frest-api-rocket%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://ventgrey.github.io/>La Esquina Gris</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>